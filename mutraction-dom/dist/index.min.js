"use strict";var G={dispose:()=>{}};function R(e,t,r={}){let n=e.startDependencyTrack(),o=t(n);if(n.endDependencyTrack(),n.trackedProperties.length===0)return r.suppressUntrackedWarning||console.warn("effect() callback has no dependencies on any tracked properties.  It will not fire again."),G;let l=n.subscribe(p);const a=()=>{n.untrackAll(),l.dispose()};function p(){o?.(),a(),n=e.startDependencyTrack(),o=t(n),n.endDependencyTrack(),l=n.subscribe(p)}return{dispose:a}}function q(e){return globalThis.document?.querySelector(`meta[name=${e.replace(/\W/g,"\\$&")}]`)?.getAttribute("value")??void 0}var z=!!q("mu:show-markers");function T(e){return document.createTextNode(z?`\u27EA${e}\u27EB`:"")}var k=class P{static id=0;startMarker=T("start:"+ ++P.id);endMarker=T("end:"+P.id);constructor(...t){document.createDocumentFragment().append(this.startMarker,...t,this.endMarker)}removeAsFragment(){if(this.startMarker.parentNode instanceof DocumentFragment)return this.startMarker.parentNode;const t=[];for(let n=this.startMarker;;n=n?.nextSibling){if(n==null)throw Error("End marker not found as subsequent document sibling as start marker");if(t.push(n),Object.is(n,this.endMarker))break}const r=document.createDocumentFragment();return r.append(...t),r}emptyAsFragment(){const t=[];for(let n=this.startMarker.nextSibling;;n=n?.nextSibling){if(n==null)throw Error("End marker not found as subsequent document sibling as start marker");if(Object.is(n,this.endMarker))break;t.push(n)}const r=document.createDocumentFragment();return r.append(...t),r}clear(){for(;!Object.is(this.startMarker.nextSibling,this.endMarker);){if(this.startMarker.nextSibling==null)throw Error("End marker not found as subsequent document sibling as start marker");this.startMarker.nextSibling.remove()}}replaceWith(...t){this.clear(),this.append(...t)}append(...t){const r=document.createDocumentFragment();if(r.append(...t),!this.endMarker.parentNode)throw Error("End marker of ElementSpan has no parent");this.endMarker.parentNode.insertBefore(r,this.endMarker)}},E=Symbol("RecordMutation"),x=Symbol("TrackerOf"),w=Symbol("ProxyOf"),D=Symbol("RecordDependency"),I=Symbol("GetOriginal"),U=["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"];function $(e){return typeof e=="string"?F(e):typeof e=="number"&&(e&2147483647)===e}function F(e){return typeof e!="string"||!/^\d{1,10}$/.test(e)?!1:parseInt(e,10)<2147483647}function B(e){return Object.prototype.toString.call(e)==="[object Arguments]"}function V(e,t){Object.defineProperty(e,w,{enumerable:!1,writable:!0,configurable:!1}),e[w]=t}function M(e,t){function r(s,i,f){if(i===x)return t;if(i===I)return s;t[D](A(s,i));let u=Reflect.get(s,i,f);if(typeof u=="object"&&!S(u)){const d=u,y=M(d,t);u=s[i]=new Proxy(d,y),V(d,u)}if(typeof u=="function"&&t.options.autoTransactionalize&&i!=="constructor"){let d=function(){const b=t.startTransaction(y.name??"auto");try{const v=y.apply(f,arguments);return b.operations.length>0?t.commit(b):t.rollback(b),v}catch(v){throw t.rollback(b),v}};var g=d;const y=u;return d}return u}function n(s,i,f){if(typeof i=="string"&&U.includes(i)){let g=function(){const y=t.startTransaction(String(i)),b=d.apply(f,arguments);return t.commit(y),b};var u=g;const d=s[i];return g}else return r(s,i,f)}let o=0;function l(s,i,f,u){if(typeof f=="object"&&!f[x]){const b=M(f,t);f=new Proxy(f,b)}const g=i in s?{type:"change",target:s,name:i,oldValue:e[i],newValue:f}:{type:"create",target:s,name:i,newValue:f},d=o,y=Reflect.set(s,i,f,u);return y&&d==o++&&t[E](g),y}function a(s,i,f,u){if(!Array.isArray(s))throw Error("This object used to be an array.  Expected an array.");if(i==="length"){$(f)||(s.length=f);const g=s.length,d=parseInt(f,10);if(d<g){const y=Object.freeze(s.slice(d,g)),b={type:"arrayshorten",target:s,name:i,oldLength:g,newLength:d,removed:y},v=Reflect.set(s,i,f,u);return t[E](b),++o,v}}if(F(i)){const g=parseInt(i,10);if(g>=s.length){const d={type:"arrayextend",target:s,name:i,oldLength:s.length,newIndex:g,newValue:f},y=Reflect.set(s,i,f,u);return t[E](d),++o,y}}return l(s,i,f,u)}function p(s,i){const f={type:"delete",target:s,name:i,oldValue:e[i]},u=Reflect.deleteProperty(s,i);return u&&t[E](f),u}let c=l,h=r;if(Array.isArray(e)&&(c=a,t.options.trackHistory&&(h=n)),B(e))throw Error("Tracking of exotic arguments objects not supported");return{get:h,set:c,deleteProperty:p}}function S(e){return typeof e=="object"&&!!e[x]}var j=class{object;prop;#t=new Set;#e=!1;constructor(e,t){!S(e)&&e[w]&&(e=e[w]),this.object=e,this.prop=t}subscribe(e){return this.#t.add(e),{dispose:this.#t.delete.bind(this.#t,e)}}notifySubscribers(){this.#e&&console.warn(`Re-entrant property subscription for '${String(this.prop)}'`),this.#e=!0;for(const e of[...this.#t])e();this.#e=!1}get current(){return this.object[this.prop]}set current(e){this.object[this.prop]=e}},W=new WeakMap;function A(e,t){let r=W.get(e);r||W.set(e,r=new Map);let n=r.get(t);return n||r.set(t,n=new j(e,t)),n}var C=class{#t=new Map;#e;#s=!1;#r=new Set;active=!0;constructor(e){this.#e=e}get trackedProperties(){return Array.from(this.#t.keys())}addDependency(e){if(this.active&&!this.#s){if(this.#t.has(e))return;const t=e.subscribe(this.notifySubscribers.bind(this));this.#t.set(e,t)}}subscribe(e){return this.#r.add(e),{dispose:()=>this.#r.delete(e)}}notifySubscribers(){for(const e of[...this.#r])e()}endDependencyTrack(){this.#e.endDependencyTrack(this)}trackAllChanges(){this.untrackAll();const e=A(this.#e,"history");this.addDependency(e),this.#s=!0}untrackAll(){for(const e of this.#t.values())e.dispose();this.#t.clear()}};function J({operations:e}){for(let t=0;t<e.length;){const r=e[t];if(r.type==="transaction")e.splice(t,1,...r.operations);else if(r.type==="change"&&Object.is(r.oldValue,r.newValue))e.splice(t,1);else if(t>0){const n=e[t-1];if(n.type==="transaction")throw Error("Internal mutraction error.  Found internal transaction on look-back during packTransaction.");n.target!==r.target||n.name!==r.name?++t:n.type==="create"&&r.type==="change"?e.splice(--t,2,{...n,newValue:r.newValue}):n.type==="create"&&r.type==="delete"?e.splice(--t,2):n.type==="change"&&r.type==="change"?e.splice(--t,2,{...n,newValue:r.newValue}):n.type==="change"&&r.type==="delete"?e.splice(--t,2,{...r,oldValue:n.oldValue}):n.type==="delete"&&r.type==="create"?e.splice(--t,2,{...r,...n,type:"change"}):++t}else++t}}var K={trackHistory:!0,autoTransactionalize:!0,deferNotifications:!1,compactOnCommit:!0},H=class{#t=new Set;#e;#s;#r=[];options;#c;constructor(e={}){e.trackHistory===!1&&e.compactOnCommit==null&&(e.compactOnCommit=!1);const t={...K,...e};if(t.autoTransactionalize&&!t.trackHistory)throw Error("Option autoTransactionalize requires option trackHistory");if(t.compactOnCommit&&!t.trackHistory)throw Error("Option compactOnCommit requires option trackHistory");t.trackHistory&&(this.#s=this.#e={type:"transaction",operations:[]}),this.options=Object.freeze(t)}track(e){if(S(e))throw Error("Object already tracked");const t=new Proxy(e,M(e,this));return Object.defineProperty(e,w,{enumerable:!1,writable:!0,configurable:!1}),e[w]=t,t}trackAsReadonlyDeep(e){return this.track(e)}subscribe(e){return this.#t.add(e),{dispose:()=>this.#t.delete(e)}}#o(e){if(this.options.deferNotifications)for(const t of this.#t)queueMicrotask(()=>t(e));else for(const t of this.#t)t(e)}#n(){if(!this.#e)throw Error("History tracking disabled.");return this.#e}get history(){if(this.#n(),this.#i[0]?.trackAllChanges(),this.#c??=A(this,"history"),!this.#s)throw Error("History tracking enabled, but no root transaction. Probably mutraction internal error.");return this.#s.operations}startTransaction(e){const t=this.#n();return this.#e={type:"transaction",parent:t,operations:[]},e&&(this.#e.transactionName=e),this.#e}commit(e){const t=this.#n();if(e&&e!==t)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(!t.parent)throw Error("Cannot commit root transaction");this.options.compactOnCommit&&J(t);const r=t.parent;r.operations.push(t),t.parent=void 0,this.#e=r,this.#e.parent==null&&this.#o(void 0)}rollback(e){const t=this.#n();if(e&&e!==t)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");for(;t.operations.length;)this.undo();this.#e=t.parent??t}undo(){const t=this.#n().operations.pop();t&&(this.#f(t),this.#r.unshift(t),this.#c?.notifySubscribers())}#f(e){if(e.type==="transaction")for(let t=e.operations.length;t-- >0;)this.#f(e.operations[t]);else{const t=e.target;switch(e.type){case"change":case"delete":t[e.name]=e.oldValue;break;case"create":delete t[e.name];break;case"arrayextend":t.length=e.oldLength;break;case"arrayshorten":t.push(...e.removed);break;default:}this.#o(e)}}redo(){const e=this.#n(),t=this.#r.shift();t&&(this.#p(t),e.operations.push(t),this.#c?.notifySubscribers())}#p(e){if(e.type==="transaction")for(const t of e.operations)this.#p(t);else{const t=e.target;switch(e.type){case"change":case"create":t[e.name]=e.newValue;break;case"delete":delete t[e.name];break;case"arrayextend":t[e.newIndex]=e.newValue;break;case"arrayshorten":t.length=e.newLength;break;default:}this.#o(e)}}clearRedos(){this.#r.length=0}clearHistory(){const e=this.#n();e.parent=void 0,e.operations.length=0,this.clearRedos(),this.#o(void 0)}[E](e){this.#e?.operations.push(Object.freeze(e)),this.clearRedos(),A(e.target,e.name).notifySubscribers(),this.#o(e),this.#c?.notifySubscribers()}#i=[];startDependencyTrack(){let e=new C(this);return this.#i.unshift(e),e}endDependencyTrack(e){if(this.#i[0]!==e)throw Error("Specified dependency list is not top of stack");return this.#i.shift(),e}[D](e){this.#i[0]?.addDependency(e),this.#l&&(this.#a=e)}#l=!1;#a=void 0;getPropRef(e){const t=this.getPropRefTolerant(e);if(!t)throw Error("No tracked properties.  Prop ref detection requires a tracked object.");return t}getPropRefTolerant(e){if(this.#l)throw Error("Cannot be called re-entrantly.");this.#l=!0,this.#a=void 0;try{const t=e();if(!this.#a)return;const r=this.#a.current;return Object.is(t,r)||console.error("The last operation of the callback must be a property get.\n`(foo || bar).quux` is allowed, but `foo.bar + 1` is not"),this.#a}finally{this.#l=!1}}},O=new H;function Q(e){return O.track(e)}var X={suppressUntrackedWarning:!0};function m(e){R(O,e,X)}function Y(e,t){const r=new k,n=[];return m(o=>{for(let l=n.length;l<e.length;l++){const a=new k;n.push(a),m(p=>{const c=t(e[l]);a.replaceWith(c)}),r.append(a.removeAsFragment())}for(;n.length>e.length;)n.pop().removeAsFragment()}),r.removeAsFragment()}function Z(e,t){const r=new k,n=[],o=new WeakMap;return m(()=>{for(let l=n.length;l<e.length;l++){const a=new k;n.push(a),m(p=>{a.emptyAsFragment();const c=e[l];if(c==null)return;if(typeof c!="object")throw Error("Elements must be object in ForEachPersist");let h=o.get(c);if(h==null){p&&(p.active=!1);let s=t(c);h=s instanceof HTMLElement?s:new k(s),o.set(c,h),p&&(p.active=!0)}h instanceof HTMLElement?a.replaceWith(h):a.replaceWith(h.removeAsFragment())}),r.append(a.removeAsFragment())}for(;n.length>e.length;)n.pop().removeAsFragment()}),r.removeAsFragment()}function _(e,t,r,...n){const o=document.createElement(e);let l;for(let[p,c]of Object.entries(t))switch(p){case"mu:syncEvent":l=c;break;default:o[p]=c;break}const a=l?[]:void 0;for(let[p,c]of Object.entries(r)){if(a&&p in o){const h=O.getPropRefTolerant(c);h&&a.push([p,h])}switch(p){case"style":m(()=>{Object.assign(o.style,c())});break;case"classList":m(()=>{const h=c();for(const s of Object.entries(h))o.classList.toggle(...s)});break;default:m(()=>{o[p]=c()});break}}if(o.append(...n),l&&a?.length)for(const p of l.matchAll(/\S+/g))o.addEventListener(p[0],()=>{for(const[c,h]of a)h.current=o[c]});return o}function ee(e){const t=e();if(t instanceof Node)return t;let r=T("placeholder");return m(()=>{const n=document.createTextNode(String(e()??""));r.replaceWith(n),r=n}),r}function L(e){let t=!1,r;function n(){return t?r:(t=!0,r=e())}return n}function te(...e){const t=[];let r=!1;for(const o of e)if("conditionGetter"in o)t.push({nodeGetter:L(o.nodeGetter),conditionGetter:o.conditionGetter});else{t.push({nodeGetter:L(o.nodeGetter)}),r=!0;break}if(!r){const o=T("if:anti-consequent");t.push({nodeGetter:()=>o})}let n=T("choice-placeholder");return R(O,()=>{for(const{nodeGetter:o,conditionGetter:l}of e)if(!l||l()){const a=o();n.replaceWith(a),n=a;break}}),n}var N=new WeakMap;function re(...e){if(e.some(o=>"pattern"in o&&o.pattern instanceof RegExp&&o.pattern.global))throw Error("Global-flagged route patterns not supported");const t=new k;let r;function n(o){const{hash:l}=new URL(o);for(const a of e){let p,c=!1;if("pattern"in a?typeof a.pattern=="string"?c=l===a.pattern:c=!!(p=a.pattern.exec(l)??void 0):c=!0,c){r?.removeAsFragment(),r=void 0;const{element:h}=a,s=typeof h=="function"?h(p):h;if(s instanceof DocumentFragment){let i=N.get(s);i||N.set(s,i=new k(s)),r=i,t.replaceWith(i.removeAsFragment())}else r=void 0,t.replaceWith(s);return}}t.emptyAsFragment()}return window.addEventListener("hashchange",o=>n(o.newURL)),n(location.href),t.removeAsFragment()}export{C as DependencyList,Y as ForEach,Z as ForEachPersist,j as PropReference,re as Router,H as Tracker,ee as child,te as choose,A as createOrRetrievePropRef,O as defaultTracker,R as effect,_ as element,S as isTracked,Q as track};
