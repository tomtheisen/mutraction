"use strict";var E=Symbol("RecordMutation"),P=Symbol("TrackerOf"),S=Symbol("ProxyOf"),C=Symbol("RecordDependency"),Y=Symbol("GetOriginal"),Z=["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"];function _(e){return typeof e=="string"?j(e):typeof e=="number"&&(e&2147483647)===e}function j(e){return typeof e!="string"||!/^\d{1,10}$/.test(e)?!1:parseInt(e,10)<2147483647}function ee(e){return Object.prototype.toString.call(e)==="[object Arguments]"}function L(e,t){Object.defineProperty(e,S,{enumerable:!1,writable:!0,configurable:!1}),e[S]=t}var H=new Set([RegExp,Promise]);"window"in globalThis&&H.add(globalThis.window.constructor);function M(e){return!(e==null||typeof e!="object"||A(e)||H.has(e.constructor))}function D(e,t){function r(c,o,i){if(o===P)return t;if(o===Y)return c;t[C](b(c,o));let p=Reflect.get(c,o,i);if(M(p)){const y=p[S];if(y){if(y[P]!==t)throw Error("Object cannot be tracked by multiple tracker isntances");p=y}else{const g=p,m=D(g,t);p=c[o]=new Proxy(g,m),L(g,p)}}if(typeof p=="function"&&t.options.autoTransactionalize&&o!=="constructor"){let y=function(){const m=t.startTransaction(g.name??"auto");try{return g.apply(i,arguments)}finally{m.operations.length>0?t.commit(m):t.rollback(m)}};var d=y;const g=p;return y}return p}function n(c,o,i){if(typeof o=="string"&&Z.includes(o)){let d=function(){const g=t.startTransaction(String(o)),m=y.apply(i,arguments);return t.commit(g),m};var p=d;const y=c[o];return d}else return r(c,o,i)}let s=0;function a(c,o,i,p){if(M(i)){const m=D(i,t);i=new Proxy(i,m)}const d=o in c?{type:"change",target:c,name:o,oldValue:e[o],newValue:i,timestamp:new Date}:{type:"create",target:c,name:o,newValue:i,timestamp:new Date},y=s,g=Reflect.set(c,o,i,p);return g&&y==s++&&t[E](d),g}function u(c,o,i,p){if(!Array.isArray(c))throw Error("This object used to be an array.  Expected an array.");if(o==="length"){_(i)||(c.length=i);const d=c.length,y=parseInt(i,10);if(y<d){const g=Object.freeze(c.slice(y,d)),m={type:"arrayshorten",target:c,name:o,oldLength:d,newLength:y,removed:g,timestamp:new Date},X=Reflect.set(c,o,i,p);return t[E](m),++s,X}}if(j(o)){const d=parseInt(o,10);if(d>=c.length){const y={type:"arrayextend",target:c,name:o,oldLength:c.length,newIndex:d,newValue:i,timestamp:new Date},g=Reflect.set(c,o,i,p);return t[E](y),++s,g}}return a(c,o,i,p)}function f(c,o){const i={type:"delete",target:c,name:o,oldValue:e[o],timestamp:new Date},p=Reflect.deleteProperty(c,o);return p&&t[E](i),p}let l=a,h=r;if(Array.isArray(e)&&(l=u,t.options.trackHistory&&(h=n)),ee(e))throw Error("Tracking of exotic arguments objects not supported");return{get:h,set:l,deleteProperty:f}}function A(e){return typeof e=="object"&&!!e[P]}var I=class{object;prop;#e=new Set;#t=!1;get subscribers(){return this.#e}constructor(e,t){!A(e)&&e[S]&&(e=e[S]),this.object=e,this.prop=t}subscribe(e){return this.#e.add(e),{dispose:()=>{this.#e.delete(e)}}}notifySubscribers(){this.#t&&console.warn(`Re-entrant property subscription for '${String(this.prop)}'`);const e=Array.from(this.#e);this.#t=!0;for(const t of e)t.notifySubscribers();this.#t=!1}get current(){return this.object[this.prop]}set current(e){this.object[this.prop]=e}},$=new WeakMap;function b(e,t){let r=$.get(e);r||$.set(e,r=new Map);let n=r.get(t);return n||r.set(t,n=new I(e,t)),n}var z=class{#e=new Map;#t;#r=!1;#s=new Set;active=!0;constructor(e){this.#t=e}get trackedProperties(){return Array.from(this.#e.keys())}addDependency(e){if(this.active&&!this.#r){if(this.#e.has(e))return;const t=e.subscribe(this);this.#e.set(e,t)}}subscribe(e){return this.#s.add(e),{dispose:()=>this.#s.delete(e)}}notifySubscribers(){const e=Array.from(this.#s);for(const t of e)t()}endDependencyTrack(){this.#t.endDependencyTrack(this)}trackAllChanges(){if(this.#r)return;this.untrackAll();const e=b(this.#t,"history");this.addDependency(e),this.#r=!0}untrackAll(){for(const e of this.#e.values())e.dispose();this.#e.clear()}};function te({operations:e}){for(let t=0;t<e.length;){const r=e[t];if(r.type==="transaction")e.splice(t,1,...r.operations);else if(r.type==="change"&&Object.is(r.oldValue,r.newValue))e.splice(t,1);else if(t>0){const n=e[t-1];if(n.type==="transaction")throw Error("Internal mutraction error.  Found internal transaction on look-back during packTransaction.");n.target!==r.target||n.name!==r.name?++t:n.type==="create"&&r.type==="change"?e.splice(--t,2,{...n,newValue:r.newValue}):n.type==="create"&&r.type==="delete"?e.splice(--t,2):n.type==="change"&&r.type==="change"?e.splice(--t,2,{...n,newValue:r.newValue}):n.type==="change"&&r.type==="delete"?e.splice(--t,2,{...r,oldValue:n.oldValue}):n.type==="delete"&&r.type==="create"?e.splice(--t,2,{...r,...n,type:"change"}):++t}else++t}}var U={trackHistory:!0,autoTransactionalize:!0,compactOnCommit:!0},q=class{#e;#t;#r=[];#s=!1;#o=[];options=U;#i;constructor(e={}){this.setOptions(e)}setOptions(e={}){if(this.#s)throw Error("Cannot change options for a tracker that has already started tracking");e.trackHistory===!1&&(e.compactOnCommit??=!1,e.autoTransactionalize??=!1);const t={...U,...e};if(t.autoTransactionalize&&!t.trackHistory)throw Error("Option autoTransactionalize requires option trackHistory");if(t.compactOnCommit&&!t.trackHistory)throw Error("Option compactOnCommit requires option trackHistory");t.trackHistory&&(this.#t=[]),this.options=Object.freeze(t)}track(e){if(A(e))throw Error("Object already tracked");if(this.#s=!0,!M)throw Error("This object type cannot be proxied");const t=new Proxy(e,D(e,this));return L(e,t),t}trackAsReadonlyDeep(e){return this.track(e)}#n(){if(!this.options.trackHistory)throw Error("History tracking disabled.")}get history(){if(this.#n(),this.#o[0]?.trackAllChanges(),this.#i??=b(this,"history"),!this.#t)throw Error("History tracking enabled, but no root transaction. Probably mutraction internal error.");return this.#t}startTransaction(e){return this.#n(),this.#e={type:"transaction",parent:this.#e,operations:[],dependencies:new Set,timestamp:new Date},e&&(this.#e.transactionName=e),this.#e}commit(e){if(this.#n(),!this.#e)throw Error("Attempted to commit transaction when none were open.");if(e&&e!==this.#e)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(this.options.compactOnCommit&&te(this.#e),this.#e.parent)this.#e.parent.operations.push(this.#e),this.#e.dependencies.forEach(t=>this.#e.parent.dependencies.add(t)),this.#e=this.#e.parent;else{this.#t.push(this.#e);const t=new Set;for(const r of this.#e.dependencies)for(const n of r.subscribers)t.add(n);for(const r of t)r.notifySubscribers();this.#e=void 0}this.#e==null&&this.#i?.notifySubscribers()}rollback(e){if(this.#n(),e&&e!==this.#e)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(this.#e){for(;this.#e.operations.length;)this.undo();this.#e=this.#e.parent}else for(;this.#t.length;)this.undo()}undo(){this.#n();const e=(this.#e?.operations??this.#t).pop();e&&(this.#l(e),this.#r.unshift(e),this.#e==null&&this.#i?.notifySubscribers())}#l(e){if(e.type==="transaction")for(let t=e.operations.length;t-- >0;)this.#l(e.operations[t]);else{const t=e.target;switch(e.type){case"change":case"delete":t[e.name]=e.oldValue;break;case"create":delete t[e.name];break;case"arrayextend":t.length=e.oldLength;break;case"arrayshorten":t.push(...e.removed);break;default:}this.#e||(b(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&b(e.target,"length").notifySubscribers())}}redo(){this.#n();const e=this.#r.shift();e&&(this.#f(e),(this.#e?.operations??this.#t).push(e),this.#e==null&&this.#i?.notifySubscribers())}#f(e){if(e.type==="transaction")for(const t of e.operations)this.#f(t);else{const t=e.target;switch(e.type){case"change":case"create":t[e.name]=e.newValue;break;case"delete":delete t[e.name];break;case"arrayextend":t[e.newIndex]=e.newValue;break;case"arrayshorten":t.length=e.newLength;break;default:}this.#e||(b(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&b(e.target,"length").notifySubscribers())}}clearRedos(){this.#r.length=0}clearHistory(){this.#n(),this.#e=void 0,this.#t.length=0,this.clearRedos()}[E](e){this.options.trackHistory&&(this.#e?.operations??this.#t).push(Object.freeze(e)),this.clearRedos(),this.#e?(this.#e.dependencies.add(b(e.target,e.name)),(e.type==="arrayextend"||e.type==="arrayshorten")&&this.#e.dependencies.add(b(e.target,"length"))):(b(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&b(e.target,"length").notifySubscribers(),this.#i?.notifySubscribers())}startDependencyTrack(){const e=new z(this);return this.#o.unshift(e),e}endDependencyTrack(e){if(this.#o[0]!==e)throw Error("Specified dependency list is not top of stack");return this.#o.shift(),e}[C](e){this.#c?this.#a=e:this.#o[0]?.addDependency(e)}#c=!1;#a=void 0;getPropRef(e){const t=this.getPropRefTolerant(e);if(!t)throw Error("No tracked properties.  Prop ref detection requires a tracked object.");return t}getPropRefTolerant(e){if(this.#c)throw Error("Cannot be called re-entrantly.");this.#c=!0,this.#a=void 0;try{const t=e();if(!this.#a)return;const r=this.#a.current;return Object.is(t,r)||console.error("The last operation of the callback must be a property get.\n`(foo || bar).quux` is allowed, but `foo.bar + 1` is not"),this.#a}finally{this.#c=!1}}},x=new q;function re(e){return x.track(e)}var ne={dispose:()=>{}};function k(e,t={}){const{tracker:r=x,suppressUntrackedWarning:n=!1}=t;let s=r.startDependencyTrack(),a;try{a=e(s)}finally{s.endDependencyTrack()}if(s.trackedProperties.length===0)return n||console.warn("effect() callback has no dependencies on any tracked properties.  It will not fire again."),ne;let u=s.subscribe(l);const f=()=>{s.untrackAll(),u.dispose()};function l(){typeof a=="function"&&a(),f(),s=r.startDependencyTrack(),a=e(s),s.endDependencyTrack(),u=s.subscribe(l)}return{dispose:f}}var F=new WeakMap;function v(e,t){const r=F.get(e);r?r.push(t):F.set(e,[t])}function T(e){F.get(e)?.forEach(r=>r.dispose()),e instanceof Element&&e.childNodes.forEach(r=>T(r))}var O={suppressUntrackedWarning:!0};function se(e){return e!=null&&typeof e=="object"&&"$muType"in e&&typeof e.$muType=="string"}function G(e,t){if(Array.isArray(t)){t.forEach(r=>G(e,r));return}if(!se(t))throw Error("Expected a node modifier for 'mu:apply', but got "+typeof t);switch(t.$muType){case"attribute":e.setAttribute(t.name,t.value);break;default:throw Error("Unknown node modifier type: "+t.$muType)}}function oe(e,t,r,...n){const s=document.createElement(e);s.append(...n);let a;for(let[f,l]of Object.entries(t))switch(f){case"mu:syncEvent":a=l;break;case"mu:apply":G(s,l);break;default:s[f]=l;break}const u=a?[]:void 0;for(let[f,l]of Object.entries(r)){if(u&&f in s){const h=x.getPropRefTolerant(l);h&&u.push([f,h])}switch(f){case"style":{const h=k(()=>{Object.assign(s.style,l())},O);v(s,h);break}case"classList":{const h=k(()=>{const c=l();for(const[o,i]of Object.entries(c))s.classList.toggle(o,!!i)},O);v(s,h);break}default:{const h=k(()=>{s[f]=l()},O);v(s,h);break}}}if(a&&u?.length)for(const f of a.matchAll(/\S+/g))s.addEventListener(f[0],()=>{for(const[l,h]of u)h.current=s[l]});return s}function ie(e){let t=document.createTextNode(""),r;return r=k(n=>{const s=e();if(s instanceof Node)n.untrackAll(),t=s;else{const a=document.createTextNode(String(s??""));r&&v(a,r),t.replaceWith(a),t=a}},O),v(t,r),t}var w=class{static id=0;startMarker=document.createTextNode("");endMarker=document.createTextNode("");constructor(...e){document.createDocumentFragment().append(this.startMarker,...e,this.endMarker)}removeAsFragment(){if(this.startMarker.parentNode instanceof DocumentFragment)return this.startMarker.parentNode;const e=[];for(let r=this.startMarker;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(e.push(r),Object.is(r,this.endMarker))break}const t=document.createDocumentFragment();return t.append(...e),t}emptyAsFragment(){const e=[];for(let r=this.startMarker.nextSibling;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(Object.is(r,this.endMarker))break;e.push(r)}const t=document.createDocumentFragment();return t.append(...e),t}replaceWith(...e){this.emptyAsFragment(),this.append(...e)}append(...e){const t=document.createDocumentFragment();if(t.append(...e),!this.endMarker.parentNode)throw Error("End marker of ElementSpan has no parent");this.endMarker.parentNode.insertBefore(t,this.endMarker)}registerCleanup(e){v(this.startMarker,e)}cleanup(){T(this.startMarker);for(const e of this.emptyAsFragment().childNodes)T(e)}};function B(e){return e!=null&&typeof e=="object"&&"node"in e&&e.node instanceof Node}function N(e){const t=new w;let r;const n=k(function(a){r?.(),r=void 0,t.cleanup();const u=e();B(u)?(t.replaceWith(u.node),r=u.cleanup):u!=null&&t.replaceWith(u)});return t.registerCleanup(n),t.removeAsFragment()}var R={suppressUntrackedWarning:!0};function V(e,t){if(typeof e=="function")return N(()=>V(e(),t));const r=new w,n=[],s=e??[];return k(function(u){for(let f=n.length;f<s.length;f++){const l={container:new w};n.push(l),k(function(c){l.cleanup?.();const o=s[f],i=o!==void 0?t(o,f,s):document.createTextNode("");B(i)?(l.container.replaceWith(i.node),l.cleanup=i.cleanup):i!=null&&(l.container.replaceWith(i),l.cleanup=void 0)},R),r.append(l.container.removeAsFragment())}for(;n.length>s.length;){const{cleanup:f,container:l}=n.pop();f?.(),l.cleanup}},R),r.removeAsFragment()}function J(e,t){if(typeof e=="function")return N(()=>J(e(),t));const r=new w,n=[],s=new WeakMap,a=e??[];return k(function(f){for(let l=n.length;l<a.length;l++){const h=new w;n.push(h),k(function(o){h.emptyAsFragment();const i=a[l];if(i==null)return;if(typeof i!="object")throw Error("Elements must be object in ForEachPersist");let p=s.get(i);if(p==null){o&&(o.active=!1);try{const d=t(i);p=d instanceof HTMLElement?d:new w(d),s.set(i,p)}finally{o&&(o.active=!0)}}p instanceof HTMLElement?h.replaceWith(p):p!=null&&h.replaceWith(p.removeAsFragment())},R),r.append(h.removeAsFragment())}for(;n.length>a.length;)n.pop().cleanup()},R),r.removeAsFragment()}var ae={suppressUntrackedWarning:!0};function ce(...e){let t=document.createTextNode("");return k(function(){let n=!1;for(const{nodeGetter:s,conditionGetter:a}of e)if(!a||a()){n=!0,T(t);const u=s();t.replaceWith(u),t=u;break}if(!n){T(t);const s=document.createTextNode("");t.replaceWith(s),t=s}},ae),t}function le(e){return document.createTextNode(String(e))}function fe(e,t=document.createTextNode(""),r=le){const n=new w(t);return e.then(s=>n.replaceWith(s)),e.catch(s=>n.replaceWith(typeof r=="function"?r(s):r)),n.removeAsFragment()}var K=new WeakMap;function pe(...e){if(e.some(a=>"pattern"in a&&a.pattern instanceof RegExp&&a.pattern.global))throw Error("Global-flagged route patterns not supported");const t=new w;let r,n=!1;function s(a){const{hash:u}=new URL(a);for(const f of e){let l,h=!1;if("pattern"in f?typeof f.pattern=="string"?h=u===f.pattern:h=!!(l=f.pattern.exec(u)??void 0):h=!0,h){n?r?.cleanup():r?.removeAsFragment(),r=void 0;const{element:c}=f;n=typeof c=="function";const o=typeof c=="function"?c(l):c;if(o instanceof DocumentFragment){let i=K.get(o);i||K.set(o,i=new w(o)),r=i,t.replaceWith(i.removeAsFragment())}else r=void 0,t.replaceWith(o);f.suppressScroll||window.scrollTo(0,0);return}}t.emptyAsFragment()}return window.addEventListener("hashchange",a=>s(a.newURL)),s(location.href),t.removeAsFragment()}var Q="data-mu-style",ue=String(Math.random()*1e6|0),he=0;function de(e){const t=new CSSStyleSheet,r=ue+"-"+ ++he;for(const[n,s]of Object.entries(e)){const a=`[${Q}="${r}"]`,u=`${a}:is(${n}), ${a} :is(${n}) {}`;t.insertRule(u,0);const f=t.cssRules.item(0);Object.assign(f.style,s)}return document.adoptedStyleSheets.push(t),{$muType:"attribute",name:Q,value:r}}function ye(e,t=10){return W(e,t)}function W(e,t){if(t<0)throw Error("Maximum depth exceeded.  Maybe there's a reference cycle?");if(typeof e!="object")return e;if(Array.isArray(e))return e.map(n=>W(n,t-1));if(e.constructor&&e.constructor!==Object)throw Error("Can't clone objects with a prototype chain or instances of classes");return Object.fromEntries(Object.entries(e).map(([r,n])=>[r,W(n,t-1)]))}var ge="0.21.3";export{z as DependencyList,V as ForEach,J as ForEachPersist,fe as PromiseLoader,I as PropReference,pe as Router,N as Swapper,q as Tracker,ie as child,ce as choose,b as createOrRetrievePropRef,x as defaultTracker,k as effect,oe as element,A as isTracked,de as makeLocalStyle,re as track,ye as untrackedClone,ge as version};
