"use strict";var A=Symbol("RecordMutation"),j=Symbol("TrackerOf"),T=Symbol("ProxyOf"),B=Symbol("RecordDependency"),ie=Symbol("GetOriginal"),R=Symbol("AccessPath"),ce="mu:debugMode",ae=250,m=!!localStorage.getItem(ce);function le(e){return Array.isArray(e)?`Array(${e.length})`:typeof e=="object"?"{ ... }":String(e)}if(m){const e=document.createElement("div");e.style.position="fixed",e.style.top="50px",e.style.left="50px",e.style.width="30em",e.style.height="20em",e.style.resize="both",e.style.zIndex="2147483647",e.style.background="#eee",e.style.color="#123",e.style.boxShadow="#000 0em 0.5em 1em",e.style.border="solid #345 0.4em",e.style.fontSize="16px",e.style.display="flex",e.style.flexDirection="column",e.style.overflow="auto";const t=document.createElement("div");t.style.fontWeight="bold",t.style.background="#123",t.style.color="#eee",t.style.padding="0.1em 1em",t.style.cursor="grab";const r=document.createElement("button");r.style.all="revert",r.style.marginRight="1em",r.append("_");let i=!1;r.addEventListener("click",n=>{(i=!i)?(e.style.maxHeight="2.4em",e.style.maxWidth="15em",e.style.minWidth="15em",e.style.overflow="hidden"):(e.style.maxHeight="",e.style.maxWidth="",e.style.minWidth="",e.style.overflow="auto")}),t.append(r,"\u03BC diagnostics");const o=document.createElement("div"),l=document.createElement("span");l.append("0"),o.append("PropRefs created: ",l);const f=document.createElement("button");f.append("List PropRefs"),f.addEventListener("click",n=>{const c=[];if(D)for(const a of D){const u=document.createElement("li");c.push(u);const p=O(a.object),d=p?p+"."+String(a.prop):String(a.prop),b=le(a.current),E=a.subscribers.size;u.append(d,": ",b,", ",`${E} ${E===1?"subscriber":"subscribers"}`)}h.replaceChildren(...c)});const h=document.createElement("ol");setInterval(()=>{l.replaceChildren(String(D?.sizeBound))},ae);const y=document.createElement("div");y.style.padding="1em",y.style.overflow="auto",y.append(o,f,h),e.append(t,y),document.body.append(e);let g=0,s=0;t.addEventListener("mousedown",n=>{const c=e.getBoundingClientRect();g=n.x-c.x,s=n.y-c.y,window.addEventListener("mousemove",a),document.body.addEventListener("mouseup",u=>{window.removeEventListener("mousemove",a)},{once:!0}),n.preventDefault();function a(u){e.style.left=u.x-g+"px",e.style.top=u.y-s+"px"}})}var pe=["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"];function fe(e){return typeof e=="string"?G(e):typeof e=="number"&&(e&2147483647)===e}function G(e){return typeof e!="string"||!/^\d{1,10}$/.test(e)?!1:parseInt(e,10)<2147483647}function ue(e){return Object.prototype.toString.call(e)==="[object Arguments]"}function q(e,t){Object.defineProperty(e,T,{enumerable:!1,writable:!0,configurable:!1}),e[T]=t}var K=new Set([RegExp,Promise]);"window"in globalThis&&K.add(globalThis.window.constructor);function F(e){return!(e==null||typeof e!="object"||P(e)||!Object.isExtensible(e)||K.has(e.constructor))}function O(e){return e[R]}function _(e,t){Object.assign(e,{[R]:t})}function N(e,t){function r(s,n,c){if(n===j)return t;if(n===ie)return s;if(n===R)return s[n];t[B](k(s,n));let a=Reflect.get(s,n,c);if(a&&typeof a=="object"&&m){const p=O(s),d=p?p+"."+String(n):String(n);_(a,d)}if(F(a)){const p=a[T];if(p){if(p[j]!==t)throw Error("Object cannot be tracked by multiple tracker instances");a=p}else{const d=a,b=N(d,t);a=s[n]=new Proxy(d,b),q(d,a)}}if(typeof a=="function"&&t.options.autoTransactionalize&&n!=="constructor"){let p=function(){const b=t.startTransaction(d.name??"auto");try{return d.apply(c,arguments)}finally{b.operations.length>0?t.commit(b):t.rollback(b)}};var u=p;const d=a;return p}return a}function i(s,n,c){if(typeof n=="string"&&pe.includes(n)){let u=function(){const d=t.startTransaction(String(n)),b=p.apply(c,arguments);return t.commit(d),b};var a=u;const p=s[n];return u}else return r(s,n,c)}let o=0;function l(s,n,c,a){if(n===R)return Reflect.set(s,R,c);if(c&&typeof c=="object"&&m){const b=(O(s)??"~")+"."+String(n);_(c,b)}if(F(c)){const b=N(c,t);c=new Proxy(c,b)}const u=n in s?{type:"change",target:s,name:n,oldValue:e[n],newValue:c,timestamp:new Date}:{type:"create",target:s,name:n,newValue:c,timestamp:new Date},p=o,d=Reflect.set(s,n,c,a);return d&&p==o++&&t[A](u),d}function f(s,n,c,a){if(!Array.isArray(s))throw Error("This object used to be an array.  Expected an array.");if(n==="length"){fe(c)||(s.length=c);const u=s.length,p=parseInt(c,10);if(p<u){const d=Object.freeze(s.slice(p,u)),b={type:"arrayshorten",target:s,name:n,oldLength:u,newLength:p,removed:d,timestamp:new Date},E=Reflect.set(s,n,c,a);return t[A](b),++o,E}}if(G(n)){const u=parseInt(n,10);if(u>=s.length){const p={type:"arrayextend",target:s,name:n,oldLength:s.length,newIndex:u,newValue:c,timestamp:new Date},d=Reflect.set(s,n,c,a);return t[A](p),++o,d}}return l(s,n,c,a)}function h(s,n){const c={type:"delete",target:s,name:n,oldValue:e[n],timestamp:new Date},a=Reflect.deleteProperty(s,n);return a&&t[A](c),a}let y=l,g=r;if(Array.isArray(e)&&(y=f,t.options.trackHistory&&(g=i)),ue(e))throw Error("Tracking of exotic arguments objects not supported");return{get:g,set:y,deleteProperty:h}}function P(e){return typeof e=="object"&&!!e[j]}var de=class{get sizeBound(){return this.#e}#e=0;items=[];registry=new FinalizationRegistry(e=>{this.#e--,delete this.items[e]});add(e){this.registry.register(e,this.#e),this.items[this.#e++]=new WeakRef(e)}*[Symbol.iterator](){for(const e of this.items){const t=e.deref();t&&(yield t)}}},D=m?new de:null,J=class{object;prop;#e=new Set;#t=!1;get subscribers(){return this.#e}constructor(e,t){!P(e)&&e[T]&&(e=e[T]),this.object=e,this.prop=t,D?.add(this)}subscribe(e){return this.#e.add(e),{dispose:()=>this.#e.delete(e)}}notifySubscribers(){this.#t&&console.warn(`Re-entrant property subscription for '${String(this.prop)}'`);const e=Array.from(this.#e);this.#t=!0;for(const t of e)t.notifySubscribers(this);this.#t=!1}get current(){return this.object[this.prop]}set current(e){this.object[this.prop]=e}},Q=new WeakMap;function k(e,t){let r=Q.get(e);r||Q.set(e,r=new Map);let i=r.get(t);return i||r.set(t,i=new J(e,t)),i}var he=class{#e=new Map;#t;#r=!1;#n=new Set;active=!0;constructor(e){this.#t=e}get trackedProperties(){return Array.from(this.#e.keys())}addDependency(e){if(this.active&&!this.#r){if(this.#e.has(e))return;const t=e.subscribe(this);this.#e.set(e,t)}}subscribe(e){return this.#n.add(e),{dispose:()=>this.#n.delete(e)}}notifySubscribers(e){const t=Array.from(this.#n);for(const r of t)r(e)}endDependencyTrack(){this.#t.endDependencyTrack(this)}trackAllChanges(){if(this.#r)return;this.untrackAll();const e=k(this.#t,"history");this.addDependency(e),this.#r=!0}untrackAll(){for(const e of this.#e.values())e.dispose();this.#e.clear()}};function ye({operations:e}){for(let t=0;t<e.length;){const r=e[t];if(r.type==="transaction")e.splice(t,1,...r.operations);else if(r.type==="change"&&Object.is(r.oldValue,r.newValue))e.splice(t,1);else if(t>0){const i=e[t-1];if(i.type==="transaction")throw Error("Internal mutraction error.  Found internal transaction on look-back during packTransaction.");i.target!==r.target||i.name!==r.name?++t:i.type==="create"&&r.type==="change"?e.splice(--t,2,{...i,newValue:r.newValue}):i.type==="create"&&r.type==="delete"?e.splice(--t,2):i.type==="change"&&r.type==="change"?e.splice(--t,2,{...i,newValue:r.newValue}):i.type==="change"&&r.type==="delete"?e.splice(--t,2,{...r,oldValue:i.oldValue}):i.type==="delete"&&r.type==="create"?e.splice(--t,2,{...r,...i,type:"change"}):++t}else++t}}var X={trackHistory:!0,autoTransactionalize:!0,compactOnCommit:!0},Y=class{#e;#t;#r=[];#n=!1;#s=[];options=X;#o;constructor(e={}){this.setOptions(e)}setOptions(e={}){if(this.#n)throw Error("Cannot change options for a tracker that has already started tracking");e.trackHistory===!1&&(e.compactOnCommit=!1,e.autoTransactionalize??=!1);const t={...X,...e};if(t.compactOnCommit&&!t.trackHistory)throw Error("Option compactOnCommit requires option trackHistory");t.trackHistory?this.#t=[]:this.#t=void 0,this.options=Object.freeze(t)}track(e){if(P(e))throw Error("Object already tracked");if(this.#n=!0,!F)throw Error("This object type cannot be proxied");const t=new Proxy(e,N(e,this));return q(e,t),t}trackAsReadonlyDeep(e){return this.track(e)}#c(){if(!this.options.trackHistory)throw Error("History tracking disabled.")}get history(){if(this.#c(),this.#s[0]?.trackAllChanges(),this.#o??=k(this,"history"),!this.#t)throw Error("History tracking enabled, but no root transaction. Probably mutraction internal error.");return this.#t}startTransaction(e){return this.#e={type:"transaction",parent:this.#e,operations:[],dependencies:new Set,timestamp:new Date},e&&(this.#e.transactionName=e),this.#e}commit(e){if(!this.#e)throw Error("Attempted to commit transaction when none were open.");if(e&&e!==this.#e)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(this.options.compactOnCommit&&ye(this.#e),this.#e.parent)this.#e.parent.operations.push(this.#e),this.#e.dependencies.forEach(t=>this.#e.parent.dependencies.add(t)),this.#e=this.#e.parent;else{this.#t?.push(this.#e);const t=new Set;for(const r of this.#e.dependencies)for(const i of r.subscribers)t.add(i);for(const r of t)r.notifySubscribers();this.#e=void 0}this.#e==null&&this.#o?.notifySubscribers()}rollback(e){if(e&&e!==this.#e)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(this.#e){for(;this.#e.operations.length;)this.undo();this.#e=this.#e.parent}else for(;this.#t?.length;)this.undo()}undo(){this.#c();const e=(this.#e?.operations??this.#t).pop();e&&(this.#l(e),this.#r.unshift(e),this.#e==null&&this.#o?.notifySubscribers())}#l(e){if(e.type==="transaction")for(let t=e.operations.length;t-- >0;)this.#l(e.operations[t]);else{const t=e.target;switch(e.type){case"change":case"delete":t[e.name]=e.oldValue;break;case"create":delete t[e.name];break;case"arrayextend":t.length=e.oldLength;break;case"arrayshorten":t.push(...e.removed);break;default:}this.#e||(k(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&k(e.target,"length").notifySubscribers())}}redo(){this.#c();const e=this.#r.shift();e&&(this.#p(e),(this.#e?.operations??this.#t).push(e),this.#e==null&&this.#o?.notifySubscribers())}#p(e){if(e.type==="transaction")for(const t of e.operations)this.#p(t);else{const t=e.target;switch(e.type){case"change":case"create":t[e.name]=e.newValue;break;case"delete":delete t[e.name];break;case"arrayextend":t[e.newIndex]=e.newValue;break;case"arrayshorten":t.length=e.newLength;break;default:}this.#e||(k(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&k(e.target,"length").notifySubscribers())}}clearRedos(){this.#r.length=0}clearHistory(){this.#c(),this.#e=void 0,this.#t.length=0,this.clearRedos()}[A](e){this.options.trackHistory&&(m&&(e.targetPath=O(e.target)),(this.#e?.operations??this.#t).push(Object.freeze(e))),this.clearRedos(),this.#e?(this.#e.dependencies.add(k(e.target,e.name)),(e.type==="arrayextend"||e.type==="arrayshorten")&&this.#e.dependencies.add(k(e.target,"length"))):(k(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&k(e.target,"length").notifySubscribers(),this.#o?.notifySubscribers())}ignoreUpdates(e){const t=this.startDependencyTrack();t.active=!1,e(),t.endDependencyTrack()}startDependencyTrack(){const e=new he(this);return this.#s.unshift(e),e}endDependencyTrack(e){if(this.#s[0]!==e)throw Error("Specified dependency list is not top of stack");return this.#s.shift(),e}[B](e){this.#a?this.#i=e:this.#s[0]?.addDependency(e)}#a=!1;#i=void 0;getPropRef(e){const t=this.getPropRefTolerant(e);if(!t)throw Error("No tracked properties.  Prop ref detection requires a tracked object.");return t}getPropRefTolerant(e){if(this.#a)throw Error("Cannot be called re-entrantly.");this.#a=!0,this.#i=void 0;try{const t=e();if(!this.#i)return;const r=this.#i.current;return Object.is(t,r)||console.error("The last operation of the callback must be a property get.\n`(foo || bar).quux` is allowed, but `foo.bar + 1` is not"),this.#i}finally{this.#a=!1}}},C=new Y;function ge(e){return C.track(e)}var be={dispose:()=>{}},H=0;function w(e,t={}){const{tracker:r=C,suppressUntrackedWarning:i=!1}=t;let o=r.startDependencyTrack(),l;try{l=e(o)}finally{o.endDependencyTrack()}if(o.trackedProperties.length===0)return i||console.warn("effect() callback has no dependencies on any tracked properties.  It will not fire again."),be;++H;let f=o.subscribe(y);const h=()=>{o.untrackAll(),f.dispose(),--H};function y(g){typeof l=="function"&&l(),h(),o=r.startDependencyTrack(),l=e(o,g),o.endDependencyTrack(),f=o.subscribe(y),++H}return{dispose:h}}var $=new WeakMap;function x(e,t){const r=$.get(e);r?r.push(t):$.set(e,[t])}function M(e){$.get(e)?.forEach(r=>r.dispose()),e instanceof Element&&e.childNodes.forEach(r=>M(r))}var L={suppressUntrackedWarning:!0};function me(e){return e!=null&&typeof e=="object"&&"$muType"in e&&typeof e.$muType=="string"}function Z(e,t){if(Array.isArray(t)){t.forEach(r=>Z(e,r));return}if(!me(t))throw Error("Expected a node modifier for 'mu:apply', but got "+typeof t);switch(t.$muType){case"attribute":e.setAttribute(t.name,t.value);break;default:throw Error("Unknown node modifier type: "+t.$muType)}}var V=new WeakMap;function S(e,t){let r=V.get(e)??[];r||V.set(e,r=[]),r.push(t)}function ke(e,t,r,...i){const o=document.createElement(e);o.append(...i);let l,f=!1,h=0,y=!1;for(let[s,n]of Object.entries(t))switch(s){case"mu:syncEvent":l=n;break;case"mu:apply":Z(o,n);break;case"mu:diagnostic":f=!0;break;default:o[s]=n;break}f&&console.trace(`[mu:diagnostic] Creating ${e}`);const g=l?[]:void 0;for(let[s,n]of Object.entries(r)){if(g&&s in o){const c=C.getPropRefTolerant(n);c&&g.push([s,c])}switch(s){case"style":{const a=w(f?function(p,d){y&&console.trace(`[mu:diagnostic] Updating ${e}`,{attribute:s,trigger:d,updates:++h}),Object.assign(o.style,n()),m&&S(o,p)}:function(p){Object.assign(o.style,n()),m&&S(o,p)},L);x(o,a);break}case"classList":{const a=w(f?function(p,d){y&&console.trace(`[mu:diagnostic] Updating ${e}`,{attribute:s,trigger:d,updates:++h});const b=n();for(const[E,oe]of Object.entries(b))o.classList.toggle(E,!!oe);m&&S(o,p)}:function(p){const d=n();for(const[b,E]of Object.entries(d))o.classList.toggle(b,!!E);m&&S(o,p)},L);x(o,a);break}default:{const a=w(f?function(p,d){y&&console.trace(`[mu:diagnostic] Updating ${e}`,{attribute:s,trigger:d,updates:++h}),o[s]=n(),m&&S(o,p)}:function(p){o[s]=n(),m&&S(o,p)},L);x(o,a);break}}}if(l&&g?.length)for(const s of l.matchAll(/\S+/g))o.addEventListener(s[0],()=>{for(const[n,c]of g)c.current=o[n]});return y=!0,o}function we(e){let t=document.createTextNode(""),r;return r=w(function(o){const l=e();if(l instanceof Node)o.untrackAll(),t=l;else{const f=document.createTextNode(String(l??""));r&&x(f,r),t.replaceWith(f),t=f,m&&S(t,o)}},L),x(t,r),t}var v=class{static id=0;startMarker=document.createTextNode("");endMarker=document.createTextNode("");constructor(...e){document.createDocumentFragment().append(this.startMarker,...e,this.endMarker)}removeAsFragment(){if(this.startMarker.parentNode instanceof DocumentFragment)return this.startMarker.parentNode;const e=[];for(let r=this.startMarker;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(e.push(r),Object.is(r,this.endMarker))break}const t=document.createDocumentFragment();return t.append(...e),t}emptyAsFragment(){const e=[];for(let r=this.startMarker.nextSibling;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(Object.is(r,this.endMarker))break;e.push(r)}const t=document.createDocumentFragment();return t.append(...e),t}replaceWith(...e){this.emptyAsFragment(),this.append(...e)}append(...e){const t=document.createDocumentFragment();if(t.append(...e),!this.endMarker.parentNode)throw Error("End marker of ElementSpan has no parent");this.endMarker.parentNode.insertBefore(t,this.endMarker)}registerCleanup(e){x(this.startMarker,e)}cleanup(){M(this.startMarker);for(const e of this.emptyAsFragment().childNodes)M(e)}};function ee(e){return e!=null&&typeof e=="object"&&"node"in e&&e.node instanceof Node}function I(e){const t=new v;let r;const i=w(function(l){r?.(),r=void 0,t.cleanup();const f=e();ee(f)?(t.replaceWith(f.node),r=f.cleanup):f!=null&&t.replaceWith(f)});return t.registerCleanup(i),t.removeAsFragment()}var W={suppressUntrackedWarning:!0};function te(e,t){if(typeof e=="function")return I(()=>te(e(),t));const r=new v,i=[],o=e??[],l=w(function(y){for(let g=i.length;g<o.length;g++){const s={container:new v};i.push(s),s.subscription=w(function(c){s.cleanup?.(),s.container.cleanup();const a=o[g],u=a!==void 0?t(a,g,o):document.createTextNode("");ee(u)?(s.container.replaceWith(u.node),s.cleanup=u.cleanup):u!=null&&(s.container.replaceWith(u),s.cleanup=void 0)},W),r.append(s.container.removeAsFragment())}for(;i.length>o.length;)f(i.pop())},W);return r.registerCleanup({dispose(){i.forEach(f)}}),r.registerCleanup(l),r.removeAsFragment();function f({cleanup:h,container:y,subscription:g}){h?.(),g?.dispose(),y.removeAsFragment(),y.cleanup()}}function re(e,t){if(typeof e=="function")return I(()=>re(e(),t));const r=new v,i=[],o=new WeakMap,l=e??[],f=w(function(g){for(let s=i.length;s<l.length;s++){const n=new v;i.push(n),w(function(a){n.emptyAsFragment();const u=l[s];if(u==null)return;if(typeof u!="object")throw Error("Elements must be object in ForEachPersist");let p=o.get(u);if(p==null){a&&(a.active=!1);try{const d=t(u);p=d instanceof HTMLElement?d:new v(d),o.set(u,p)}finally{a&&(a.active=!0)}}p instanceof HTMLElement?n.replaceWith(p):p!=null&&n.replaceWith(p.removeAsFragment())},W),r.append(n.removeAsFragment())}for(;i.length>l.length;)h(i.pop())},W);return r.registerCleanup({dispose(){i.forEach(h)}}),r.registerCleanup(f),r.removeAsFragment();function h(y){y.removeAsFragment(),y.cleanup()}}var ve={suppressUntrackedWarning:!0};function z(){return document.createTextNode("")}function Ee(...e){let t=z(),r=z;return w(function(){let o;for(const{nodeGetter:l,conditionGetter:f}of e)if(!f||f()){o=l;break}if(o??=z,o!==r){M(t),r=o;const l=r();t.replaceWith(l),t=l}},ve),t}function Se(e){return document.createTextNode(String(e))}function xe(e,t=document.createTextNode(""),r=Se){const i=new v(t);return e.then(o=>i.replaceWith(o)),e.catch(o=>i.replaceWith(typeof r=="function"?r(o):r)),i.removeAsFragment()}var ne=new WeakMap;function Ae(...e){if(e.some(l=>"pattern"in l&&l.pattern instanceof RegExp&&l.pattern.global))throw Error("Global-flagged route patterns not supported");const t=new v;let r,i=!1;function o(l){const{hash:f}=new URL(l);for(const h of e){let y,g=!1;if("pattern"in h?typeof h.pattern=="string"?g=f===h.pattern:g=!!(y=h.pattern.exec(f)??void 0):g=!0,g){i?r?.cleanup():r?.removeAsFragment(),r=void 0;const{element:s}=h;i=typeof s=="function";const n=typeof s=="function"?s(y):s;if(n instanceof DocumentFragment){let c=ne.get(n);c||ne.set(n,c=new v(n)),r=c,t.replaceWith(c.removeAsFragment())}else r=void 0,t.replaceWith(n);h.suppressScroll||window.scrollTo(0,0);return}}t.emptyAsFragment()}return window.addEventListener("hashchange",l=>o(l.newURL)),o(location.href),t.removeAsFragment()}var se="data-mu-style",Te=String(Math.random()*1e6|0),Re=0;function Oe(e){const t=new CSSStyleSheet,r=Te+"-"+ ++Re;for(const[i,o]of Object.entries(e)){const l=`[${se}="${r}"]`,f=`${l}:is(${i}), ${l} :is(${i}) {}`;t.insertRule(f,0);const h=t.cssRules.item(0);Object.assign(h.style,o)}return document.adoptedStyleSheets.push(t),{$muType:"attribute",name:se,value:r}}function Pe(e,t=10){return U(e,t)}function U(e,t){if(t<0)throw Error("Maximum depth exceeded.  Maybe there's a reference cycle?");if(typeof e!="object")return e;if(Array.isArray(e))return e.map(i=>U(i,t-1));if(e.constructor&&e.constructor!==Object)throw Error("Can't clone objects with a prototype chain or instances of classes");return Object.fromEntries(Object.entries(e).map(([r,i])=>[r,U(i,t-1)]))}var De="0.22.4";export{te as ForEach,re as ForEachPersist,xe as PromiseLoader,J as PropReference,Ae as Router,I as Swapper,Y as Tracker,we as child,Ee as choose,k as createOrRetrievePropRef,C as defaultTracker,w as effect,ke as element,P as isTracked,Oe as makeLocalStyle,ge as track,Pe as untrackedClone,De as version};
