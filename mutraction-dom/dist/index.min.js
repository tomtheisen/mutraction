"use strict";var T=Symbol("RecordMutation"),P=Symbol("TrackerOf"),v=Symbol("ProxyOf"),F=Symbol("RecordDependency"),U=Symbol("GetOriginal"),B=["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"];function V(e){return typeof e=="string"?D(e):typeof e=="number"&&(e&2147483647)===e}function D(e){return typeof e!="string"||!/^\d{1,10}$/.test(e)?!1:parseInt(e,10)<2147483647}function J(e){return Object.prototype.toString.call(e)==="[object Arguments]"}function K(e,t){Object.defineProperty(e,v,{enumerable:!1,writable:!0,configurable:!1}),e[v]=t}function W(e){return!(e==null||typeof e!="object"||A(e)||e instanceof Promise)}function R(e,t){function r(o,a,f){if(a===P)return t;if(a===U)return o;t[F](k(o,a));let h=Reflect.get(o,a,f);if(W(h)){const d=h,y=R(d,t);h=o[a]=new Proxy(d,y),K(d,h)}if(typeof h=="function"&&t.options.autoTransactionalize&&a!=="constructor"){let d=function(){const b=t.startTransaction(y.name??"auto");try{return y.apply(f,arguments)}finally{b.operations.length>0?t.commit(b):t.rollback(b)}};var g=d;const y=h;return d}return h}function n(o,a,f){if(typeof a=="string"&&B.includes(a)){let g=function(){const y=t.startTransaction(String(a)),b=d.apply(f,arguments);return t.commit(y),b};var h=g;const d=o[a];return g}else return r(o,a,f)}let s=0;function c(o,a,f,h){if(W(f)){const b=R(f,t);f=new Proxy(f,b)}const g=a in o?{type:"change",target:o,name:a,oldValue:e[a],newValue:f}:{type:"create",target:o,name:a,newValue:f},d=s,y=Reflect.set(o,a,f,h);return y&&d==s++&&t[T](g),y}function i(o,a,f,h){if(!Array.isArray(o))throw Error("This object used to be an array.  Expected an array.");if(a==="length"){V(f)||(o.length=f);const g=o.length,d=parseInt(f,10);if(d<g){const y=Object.freeze(o.slice(d,g)),b={type:"arrayshorten",target:o,name:a,oldLength:g,newLength:d,removed:y},q=Reflect.set(o,a,f,h);return t[T](b),++s,q}}if(D(a)){const g=parseInt(a,10);if(g>=o.length){const d={type:"arrayextend",target:o,name:a,oldLength:o.length,newIndex:g,newValue:f},y=Reflect.set(o,a,f,h);return t[T](d),++s,y}}return c(o,a,f,h)}function p(o,a){const f={type:"delete",target:o,name:a,oldValue:e[a]},h=Reflect.deleteProperty(o,a);return h&&t[T](f),h}let l=c,u=r;if(Array.isArray(e)&&(l=i,t.options.trackHistory&&(u=n)),J(e))throw Error("Tracking of exotic arguments objects not supported");return{get:u,set:l,deleteProperty:p}}function A(e){return typeof e=="object"&&!!e[P]}var j=class{object;prop;#e=new Set;#t=!1;constructor(e,t){!A(e)&&e[v]&&(e=e[v]),this.object=e,this.prop=t}subscribe(e){return this.#e.add(e),{dispose:()=>{this.#e.delete(e)}}}notifySubscribers(){this.#t&&console.warn(`Re-entrant property subscription for '${String(this.prop)}'`);const e=Array.from(this.#e);this.#t=!0;for(const t of e)t.notifySubscribers();this.#t=!1}get current(){return this.object[this.prop]}set current(e){this.object[this.prop]=e}},C=new WeakMap;function k(e,t){let r=C.get(e);r||C.set(e,r=new Map);let n=r.get(t);return n||r.set(t,n=new j(e,t)),n}var N=class{#e=new Map;#t;#n=!1;#r=new Set;active=!0;constructor(e){this.#t=e}get trackedProperties(){return Array.from(this.#e.keys())}addDependency(e){if(this.active&&!this.#n){if(this.#e.has(e))return;const t=e.subscribe(this);this.#e.set(e,t)}}subscribe(e){return this.#r.add(e),{dispose:()=>this.#r.delete(e)}}notifySubscribers(){const e=Array.from(this.#r);for(const t of e)t()}endDependencyTrack(){this.#t.endDependencyTrack(this)}trackAllChanges(){if(this.#n)return;this.untrackAll();const e=k(this.#t,"history");this.addDependency(e),this.#n=!0}untrackAll(){for(const e of this.#e.values())e.dispose();this.#e.clear()}};function Q({operations:e}){for(let t=0;t<e.length;){const r=e[t];if(r.type==="transaction")e.splice(t,1,...r.operations);else if(r.type==="change"&&Object.is(r.oldValue,r.newValue))e.splice(t,1);else if(t>0){const n=e[t-1];if(n.type==="transaction")throw Error("Internal mutraction error.  Found internal transaction on look-back during packTransaction.");n.target!==r.target||n.name!==r.name?++t:n.type==="create"&&r.type==="change"?e.splice(--t,2,{...n,newValue:r.newValue}):n.type==="create"&&r.type==="delete"?e.splice(--t,2):n.type==="change"&&r.type==="change"?e.splice(--t,2,{...n,newValue:r.newValue}):n.type==="change"&&r.type==="delete"?e.splice(--t,2,{...r,oldValue:n.oldValue}):n.type==="delete"&&r.type==="create"?e.splice(--t,2,{...r,...n,type:"change"}):++t}else++t}}var X={trackHistory:!0,autoTransactionalize:!0,compactOnCommit:!0},L=class{#e;#t;#n=[];options;#r;constructor(e={}){e.trackHistory===!1&&e.compactOnCommit==null&&(e.compactOnCommit=!1);const t={...X,...e};if(t.autoTransactionalize&&!t.trackHistory)throw Error("Option autoTransactionalize requires option trackHistory");if(t.compactOnCommit&&!t.trackHistory)throw Error("Option compactOnCommit requires option trackHistory");t.trackHistory&&(this.#t=this.#e={type:"transaction",operations:[]}),this.options=Object.freeze(t)}track(e){if(A(e))throw Error("Object already tracked");const t=new Proxy(e,R(e,this));return Object.defineProperty(e,v,{enumerable:!1,writable:!0,configurable:!1}),e[v]=t,t}trackAsReadonlyDeep(e){return this.track(e)}#s(){if(!this.#e)throw Error("History tracking disabled.");return this.#e}get history(){if(this.#s(),this.#o[0]?.trackAllChanges(),this.#r??=k(this,"history"),!this.#t)throw Error("History tracking enabled, but no root transaction. Probably mutraction internal error.");return this.#t.operations}startTransaction(e){const t=this.#s();return this.#e={type:"transaction",parent:t,operations:[]},e&&(this.#e.transactionName=e),this.#e}commit(e){const t=this.#s();if(e&&e!==t)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(!t.parent)throw Error("Cannot commit root transaction");this.options.compactOnCommit&&Q(t);const r=t.parent;r.operations.push(t),t.parent=void 0,this.#e=r,this.#e.parent==null&&this.#r?.notifySubscribers()}rollback(e){const t=this.#s();if(e&&e!==t)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");for(;t.operations.length;)this.undo();this.#e=t.parent??t}undo(){const e=this.#s(),t=e.operations.pop();t&&(this.#c(t),this.#n.unshift(t),e.parent==null&&this.#r?.notifySubscribers())}#c(e){if(e.type==="transaction")for(let t=e.operations.length;t-- >0;)this.#c(e.operations[t]);else{const t=e.target;switch(e.type){case"change":case"delete":t[e.name]=e.oldValue;break;case"create":delete t[e.name];break;case"arrayextend":t.length=e.oldLength;break;case"arrayshorten":t.push(...e.removed);break;default:}k(e.target,e.name).notifySubscribers()}}redo(){const e=this.#s(),t=this.#n.shift();t&&(this.#l(t),e.operations.push(t),e.parent==null&&this.#r?.notifySubscribers())}#l(e){if(e.type==="transaction")for(const t of e.operations)this.#l(t);else{const t=e.target;switch(e.type){case"change":case"create":t[e.name]=e.newValue;break;case"delete":delete t[e.name];break;case"arrayextend":t[e.newIndex]=e.newValue;break;case"arrayshorten":t.length=e.newLength;break;default:}k(e.target,e.name).notifySubscribers()}}clearRedos(){this.#n.length=0}clearHistory(){const e=this.#s();e.parent=void 0,e.operations.length=0,this.clearRedos()}[T](e){this.#e?.operations.push(Object.freeze(e)),this.clearRedos(),k(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&k(e.target,"length").notifySubscribers(),this.#e&&this.#e.parent==null&&this.#r?.notifySubscribers()}#o=[];startDependencyTrack(){const e=new N(this);return this.#o.unshift(e),e}endDependencyTrack(e){if(this.#o[0]!==e)throw Error("Specified dependency list is not top of stack");return this.#o.shift(),e}[F](e){this.#o[0]?.addDependency(e),this.#a&&(this.#i=e)}#a=!1;#i=void 0;getPropRef(e){const t=this.getPropRefTolerant(e);if(!t)throw Error("No tracked properties.  Prop ref detection requires a tracked object.");return t}getPropRefTolerant(e){if(this.#a)throw Error("Cannot be called re-entrantly.");this.#a=!0,this.#i=void 0;try{const t=e();if(!this.#i)return;const r=this.#i.current;return Object.is(t,r)||console.error("The last operation of the callback must be a property get.\n`(foo || bar).quux` is allowed, but `foo.bar + 1` is not"),this.#i}finally{this.#a=!1}}},E=new L;function Y(e){return E.track(e)}var Z={dispose:()=>{}};function w(e,t={}){const{tracker:r=E,suppressUntrackedWarning:n=!1}=t;let s=r.startDependencyTrack(),c=e(s);if(s.endDependencyTrack(),s.trackedProperties.length===0)return n||console.warn("effect() callback has no dependencies on any tracked properties.  It will not fire again."),Z;let i=s.subscribe(l);const p=()=>{s.untrackAll(),i.dispose()};function l(){c?.(),p(),s=r.startDependencyTrack(),c=e(s),s.endDependencyTrack(),i=s.subscribe(l)}return{dispose:p}}function _(e){return globalThis.document?.querySelector(`meta[name=${e.replace(/\W/g,"\\$&")}]`)?.getAttribute("value")??void 0}var ee=!!_("mu:show-markers");function S(e){return document.createTextNode(ee?`\u27EA${e}\u27EB`:"")}var te={suppressUntrackedWarning:!0};function O(e){w(e,te)}function re(e){return e!=null&&typeof e=="object"&&"$muType"in e&&typeof e.$muType=="string"}function H(e,t){if(Array.isArray(t)){t.forEach(r=>H(e,r));return}if(!re(t))throw Error("Expected a node modifier for 'mu:apply', but got "+typeof t);switch(t.$muType){case"attribute":e.setAttribute(t.name,t.value);break;default:throw Error("Unknown node modifier type: "+t.$muType)}}function ne(e,t,r,...n){const s=document.createElement(e);s.append(...n);let c;for(let[p,l]of Object.entries(t))switch(p){case"mu:syncEvent":c=l;break;case"mu:apply":H(s,l);break;default:s[p]=l;break}const i=c?[]:void 0;for(let[p,l]of Object.entries(r)){if(i&&p in s){const u=E.getPropRefTolerant(l);u&&i.push([p,u])}switch(p){case"style":O(()=>{Object.assign(s.style,l())});break;case"classList":O(()=>{const u=l();for(const o of Object.entries(u))s.classList.toggle(...o)});break;default:O(()=>{s[p]=l()});break}}if(c&&i?.length)for(const p of c.matchAll(/\S+/g))s.addEventListener(p[0],()=>{for(const[l,u]of i)u.current=s[l]});return s}function se(e){const t=e();if(t instanceof Node)return t;let r=S("placeholder");return O(()=>{const n=document.createTextNode(String(e()??""));r.replaceWith(n),r=n}),r}var m=class M{static id=0;startMarker=S("start:"+ ++M.id);endMarker=S("end:"+M.id);constructor(...t){document.createDocumentFragment().append(this.startMarker,...t,this.endMarker)}removeAsFragment(){if(this.startMarker.parentNode instanceof DocumentFragment)return this.startMarker.parentNode;const t=[];for(let n=this.startMarker;;n=n?.nextSibling){if(n==null)throw Error("End marker not found as subsequent document sibling as start marker");if(t.push(n),Object.is(n,this.endMarker))break}const r=document.createDocumentFragment();return r.append(...t),r}emptyAsFragment(){const t=[];for(let n=this.startMarker.nextSibling;;n=n?.nextSibling){if(n==null)throw Error("End marker not found as subsequent document sibling as start marker");if(Object.is(n,this.endMarker))break;t.push(n)}const r=document.createDocumentFragment();return r.append(...t),r}clear(){for(;!Object.is(this.startMarker.nextSibling,this.endMarker);){if(this.startMarker.nextSibling==null)throw Error("End marker not found as subsequent document sibling as start marker");this.startMarker.nextSibling.remove()}}replaceWith(...t){this.clear(),this.append(...t)}append(...t){const r=document.createDocumentFragment();if(r.append(...t),!this.endMarker.parentNode)throw Error("End marker of ElementSpan has no parent");this.endMarker.parentNode.insertBefore(r,this.endMarker)}};function $(e){return e!=null&&typeof e=="object"&&"node"in e&&e.node instanceof Node}var x={suppressUntrackedWarning:!0};function oe(e,t){const r=new m,n=[];return w(s=>{for(let c=n.length;c<e.length;c++){const i={container:new m};n.push(i),w(p=>{i.cleanup?.();const l=e[c],u=l!==void 0?t(l,c,e):S("ForEach undefined placeholder");$(u)?(i.container.replaceWith(u.node),i.cleanup=u.cleanup):(i.container.replaceWith(u),i.cleanup=void 0)},x),r.append(i.container.removeAsFragment())}for(;n.length>e.length;){const{cleanup:c,container:i}=n.pop();c?.(),i.removeAsFragment()}},x),r.removeAsFragment()}function ie(e,t){const r=new m,n=[],s=new WeakMap;return w(()=>{for(let c=n.length;c<e.length;c++){const i=new m;n.push(i),w(p=>{i.emptyAsFragment();const l=e[c];if(l==null)return;if(typeof l!="object")throw Error("Elements must be object in ForEachPersist");let u=s.get(l);if(u==null){p&&(p.active=!1);let o=t(l);u=o instanceof HTMLElement?o:new m(o),s.set(l,u),p&&(p.active=!0)}u instanceof HTMLElement?i.replaceWith(u):i.replaceWith(u.removeAsFragment())},x),r.append(i.removeAsFragment())}for(;n.length>e.length;)n.pop().removeAsFragment()},x),r.removeAsFragment()}function G(e){let t=!1,r;function n(){return t?r:(t=!0,r=e())}return n}var ae={suppressUntrackedWarning:!0};function ce(...e){const t=[];let r=!1;for(const s of e)if("conditionGetter"in s)t.push({nodeGetter:G(s.nodeGetter),conditionGetter:s.conditionGetter});else{t.push({nodeGetter:G(s.nodeGetter)}),r=!0;break}if(!r){const s=S("if:anti-consequent");t.push({nodeGetter:()=>s})}let n=S("choice-placeholder");return w(()=>{for(const{nodeGetter:s,conditionGetter:c}of t)if(!c||c()){const i=s();n.replaceWith(i),n=i;break}},ae),n}function le(e){return document.createTextNode(String(e))}function pe(e,t=document.createTextNode(""),r=le){const n=new m(t);return e.then(s=>n.replaceWith(s)),e.catch(s=>n.replaceWith(typeof r=="function"?r(s):r)),n.removeAsFragment()}function ue(e,t){try{return e()}catch(r){return t(r)}}function fe(e){const t=new m;let r;return w(()=>{r?.();const n=e();$(n)?(t.replaceWith(n.node),r=n.cleanup):(t.replaceWith(n),r=void 0)}),t.removeAsFragment()}var z=new WeakMap;function he(...e){if(e.some(s=>"pattern"in s&&s.pattern instanceof RegExp&&s.pattern.global))throw Error("Global-flagged route patterns not supported");const t=new m;let r;function n(s){const{hash:c}=new URL(s);for(const i of e){let p,l=!1;if("pattern"in i?typeof i.pattern=="string"?l=c===i.pattern:l=!!(p=i.pattern.exec(c)??void 0):l=!0,l){r?.removeAsFragment(),r=void 0;const{element:u}=i,o=typeof u=="function"?u(p):u;if(o instanceof DocumentFragment){let a=z.get(o);a||z.set(o,a=new m(o)),r=a,t.replaceWith(a.removeAsFragment())}else r=void 0,t.replaceWith(o);i.suppressScroll||window.scrollTo(0,0);return}}t.emptyAsFragment()}return window.addEventListener("hashchange",s=>n(s.newURL)),n(location.href),t.removeAsFragment()}var I="data-mu-style",de=String(Math.random()*1e6|0),ye=0;function ge(e){const t=new CSSStyleSheet,r=de+"-"+ ++ye;for(const[n,s]of Object.entries(e)){const c=`[${I}="${r}"]`,i=`${c}:is(${n}), ${c} :is(${n}) {}`;t.insertRule(i,0);const p=t.cssRules.item(0);Object.assign(p.style,s)}return document.adoptedStyleSheets.push(t),{$muType:"attribute",name:I,value:r}}console.log("setting up mutraction");var be="0.19.0";export{N as DependencyList,ue as ErrorBoundary,oe as ForEach,ie as ForEachPersist,pe as PromiseLoader,j as PropReference,he as Router,fe as Swapper,L as Tracker,se as child,ce as choose,k as createOrRetrievePropRef,E as defaultTracker,w as effect,ne as element,A as isTracked,ge as makeLocalStyle,Y as track,be as version};
