"use strict";var T=Symbol("RecordMutation"),j=Symbol("TrackerOf"),v=Symbol("ProxyOf"),F=Symbol("RecordDependency"),J=Symbol("GetOriginal"),Q=["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"];function X(e){return typeof e=="string"?W(e):typeof e=="number"&&(e&2147483647)===e}function W(e){return typeof e!="string"||!/^\d{1,10}$/.test(e)?!1:parseInt(e,10)<2147483647}function Y(e){return Object.prototype.toString.call(e)==="[object Arguments]"}function Z(e,t){Object.defineProperty(e,v,{enumerable:!1,writable:!0,configurable:!1}),e[v]=t}var N=new Set([RegExp,Promise]);"window"in globalThis&&N.add(globalThis.window.constructor);function D(e){return!(e==null||typeof e!="object"||S(e)||N.has(e.constructor))}function P(e,t){function r(o,i,h){if(i===j)return t;if(i===J)return o;t[F](g(o,i));let u=Reflect.get(o,i,h);if(D(u)){const d=u,y=P(d,t);u=o[i]=new Proxy(d,y),Z(d,u)}if(typeof u=="function"&&t.options.autoTransactionalize&&i!=="constructor"){let d=function(){const m=t.startTransaction(y.name??"auto");try{return y.apply(h,arguments)}finally{m.operations.length>0?t.commit(m):t.rollback(m)}};var b=d;const y=u;return d}return u}function n(o,i,h){if(typeof i=="string"&&Q.includes(i)){let b=function(){const y=t.startTransaction(String(i)),m=d.apply(h,arguments);return t.commit(y),m};var u=b;const d=o[i];return b}else return r(o,i,h)}let s=0;function c(o,i,h,u){if(D(h)){const m=P(h,t);h=new Proxy(h,m)}const b=i in o?{type:"change",target:o,name:i,oldValue:e[i],newValue:h,timestamp:new Date}:{type:"create",target:o,name:i,newValue:h,timestamp:new Date},d=s,y=Reflect.set(o,i,h,u);return y&&d==s++&&t[T](b),y}function a(o,i,h,u){if(!Array.isArray(o))throw Error("This object used to be an array.  Expected an array.");if(i==="length"){X(h)||(o.length=h);const b=o.length,d=parseInt(h,10);if(d<b){const y=Object.freeze(o.slice(d,b)),m={type:"arrayshorten",target:o,name:i,oldLength:b,newLength:d,removed:y,timestamp:new Date},K=Reflect.set(o,i,h,u);return t[T](m),++s,K}}if(W(i)){const b=parseInt(i,10);if(b>=o.length){const d={type:"arrayextend",target:o,name:i,oldLength:o.length,newIndex:b,newValue:h,timestamp:new Date},y=Reflect.set(o,i,h,u);return t[T](d),++s,y}}return c(o,i,h,u)}function f(o,i){const h={type:"delete",target:o,name:i,oldValue:e[i],timestamp:new Date},u=Reflect.deleteProperty(o,i);return u&&t[T](h),u}let l=c,p=r;if(Array.isArray(e)&&(l=a,t.options.trackHistory&&(p=n)),Y(e))throw Error("Tracking of exotic arguments objects not supported");return{get:p,set:l,deleteProperty:f}}function S(e){return typeof e=="object"&&!!e[j]}var L=class{object;prop;#e=new Set;#t=!1;get subscribers(){return this.#e}constructor(e,t){!S(e)&&e[v]&&(e=e[v]),this.object=e,this.prop=t}subscribe(e){return this.#e.add(e),{dispose:()=>{this.#e.delete(e)}}}notifySubscribers(){this.#t&&console.warn(`Re-entrant property subscription for '${String(this.prop)}'`);const e=Array.from(this.#e);this.#t=!0;for(const t of e)t.notifySubscribers();this.#t=!1}get current(){return this.object[this.prop]}set current(e){this.object[this.prop]=e}},H=new WeakMap;function g(e,t){let r=H.get(e);r||H.set(e,r=new Map);let n=r.get(t);return n||r.set(t,n=new L(e,t)),n}var C=class{#e=new Map;#t;#r=!1;#n=new Set;active=!0;constructor(e){this.#t=e}get trackedProperties(){return Array.from(this.#e.keys())}addDependency(e){if(this.active&&!this.#r){if(this.#e.has(e))return;const t=e.subscribe(this);this.#e.set(e,t)}}subscribe(e){return this.#n.add(e),{dispose:()=>this.#n.delete(e)}}notifySubscribers(){const e=Array.from(this.#n);for(const t of e)t()}endDependencyTrack(){this.#t.endDependencyTrack(this)}trackAllChanges(){if(this.#r)return;this.untrackAll();const e=g(this.#t,"history");this.addDependency(e),this.#r=!0}untrackAll(){for(const e of this.#e.values())e.dispose();this.#e.clear()}};function _({operations:e}){for(let t=0;t<e.length;){const r=e[t];if(r.type==="transaction")e.splice(t,1,...r.operations);else if(r.type==="change"&&Object.is(r.oldValue,r.newValue))e.splice(t,1);else if(t>0){const n=e[t-1];if(n.type==="transaction")throw Error("Internal mutraction error.  Found internal transaction on look-back during packTransaction.");n.target!==r.target||n.name!==r.name?++t:n.type==="create"&&r.type==="change"?e.splice(--t,2,{...n,newValue:r.newValue}):n.type==="create"&&r.type==="delete"?e.splice(--t,2):n.type==="change"&&r.type==="change"?e.splice(--t,2,{...n,newValue:r.newValue}):n.type==="change"&&r.type==="delete"?e.splice(--t,2,{...r,oldValue:n.oldValue}):n.type==="delete"&&r.type==="create"?e.splice(--t,2,{...r,...n,type:"change"}):++t}else++t}}var z={trackHistory:!0,autoTransactionalize:!0,compactOnCommit:!0},G=class{#e;#t;#r=[];#n=!1;#s=[];options=z;#i;constructor(e={}){this.setOptions(e)}setOptions(e={}){if(this.#n)throw Error("Cannot change options for a tracker that has already started tracking");e.trackHistory===!1&&(e.compactOnCommit??=!1,e.autoTransactionalize??=!1);const t={...z,...e};if(t.autoTransactionalize&&!t.trackHistory)throw Error("Option autoTransactionalize requires option trackHistory");if(t.compactOnCommit&&!t.trackHistory)throw Error("Option compactOnCommit requires option trackHistory");t.trackHistory&&(this.#t=[]),this.options=Object.freeze(t)}track(e){if(S(e))throw Error("Object already tracked");if(this.#n=!0,!D)throw Error("This object type cannot be proxied");const t=new Proxy(e,P(e,this));return Object.defineProperty(e,v,{enumerable:!1,writable:!0,configurable:!1}),e[v]=t,t}trackAsReadonlyDeep(e){return this.track(e)}#o(){if(!this.options.trackHistory)throw Error("History tracking disabled.")}get history(){if(this.#o(),this.#s[0]?.trackAllChanges(),this.#i??=g(this,"history"),!this.#t)throw Error("History tracking enabled, but no root transaction. Probably mutraction internal error.");return this.#t}startTransaction(e){return this.#o(),this.#e={type:"transaction",parent:this.#e,operations:[],dependencies:new Set,timestamp:new Date},e&&(this.#e.transactionName=e),this.#e}commit(e){if(this.#o(),!this.#e)throw Error("Attempted to commit transaction when none were open.");if(e&&e!==this.#e)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(this.options.compactOnCommit&&_(this.#e),this.#e.parent)this.#e.parent.operations.push(this.#e),this.#e.dependencies.forEach(t=>this.#e.parent.dependencies.add(t)),this.#e=this.#e.parent;else{this.#t.push(this.#e);const t=new Set;for(const r of this.#e.dependencies)for(const n of r.subscribers)t.add(n);t.forEach(r=>r.notifySubscribers()),this.#e=void 0}this.#e==null&&this.#i?.notifySubscribers()}rollback(e){if(this.#o(),e&&e!==this.#e)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(this.#e){for(;this.#e.operations.length;)this.undo();this.#e=this.#e.parent}else for(;this.#t.length;)this.undo()}undo(){this.#o();const e=(this.#e?.operations??this.#t).pop();e&&(this.#l(e),this.#r.unshift(e),this.#e==null&&this.#i?.notifySubscribers())}#l(e){if(e.type==="transaction")for(let t=e.operations.length;t-- >0;)this.#l(e.operations[t]);else{const t=e.target;switch(e.type){case"change":case"delete":t[e.name]=e.oldValue;break;case"create":delete t[e.name];break;case"arrayextend":t.length=e.oldLength;break;case"arrayshorten":t.push(...e.removed);break;default:}this.#e||(g(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&g(e.target,"length").notifySubscribers())}}redo(){this.#o();const e=this.#r.shift();e&&(this.#p(e),(this.#e?.operations??this.#t).push(e),this.#e==null&&this.#i?.notifySubscribers())}#p(e){if(e.type==="transaction")for(const t of e.operations)this.#p(t);else{const t=e.target;switch(e.type){case"change":case"create":t[e.name]=e.newValue;break;case"delete":delete t[e.name];break;case"arrayextend":t[e.newIndex]=e.newValue;break;case"arrayshorten":t.length=e.newLength;break;default:}this.#e||(g(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&g(e.target,"length").notifySubscribers())}}clearRedos(){this.#r.length=0}clearHistory(){this.#o(),this.#e=void 0,this.#t.length=0,this.clearRedos()}[T](e){this.options.trackHistory&&(this.#e?.operations??this.#t).push(Object.freeze(e)),this.clearRedos(),this.#e?(this.#e.dependencies.add(g(e.target,e.name)),(e.type==="arrayextend"||e.type==="arrayshorten")&&this.#e.dependencies.add(g(e.target,"length"))):(g(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&g(e.target,"length").notifySubscribers(),this.#i?.notifySubscribers())}startDependencyTrack(){const e=new C(this);return this.#s.unshift(e),e}endDependencyTrack(e){if(this.#s[0]!==e)throw Error("Specified dependency list is not top of stack");return this.#s.shift(),e}[F](e){this.#c?this.#a=e:this.#s[0]?.addDependency(e)}#c=!1;#a=void 0;getPropRef(e){const t=this.getPropRefTolerant(e);if(!t)throw Error("No tracked properties.  Prop ref detection requires a tracked object.");return t}getPropRefTolerant(e){if(this.#c)throw Error("Cannot be called re-entrantly.");this.#c=!0,this.#a=void 0;try{const t=e();if(!this.#a)return;const r=this.#a.current;return Object.is(t,r)||console.error("The last operation of the callback must be a property get.\n`(foo || bar).quux` is allowed, but `foo.bar + 1` is not"),this.#a}finally{this.#c=!1}}},x=new G;function ee(e){return x.track(e)}var te={dispose:()=>{}};function k(e,t={}){const{tracker:r=x,suppressUntrackedWarning:n=!1}=t;let s=r.startDependencyTrack(),c;try{c=e(s)}finally{s.endDependencyTrack()}if(s.trackedProperties.length===0)return n||console.warn("effect() callback has no dependencies on any tracked properties.  It will not fire again."),te;let a=s.subscribe(l);const f=()=>{s.untrackAll(),a.dispose()};function l(){typeof c=="function"&&c(),f(),s=r.startDependencyTrack(),c=e(s),s.endDependencyTrack(),a=s.subscribe(l)}return{dispose:f}}var re={suppressUntrackedWarning:!0};function A(e){k(e,re)}function ne(e){return e!=null&&typeof e=="object"&&"$muType"in e&&typeof e.$muType=="string"}function $(e,t){if(Array.isArray(t)){t.forEach(r=>$(e,r));return}if(!ne(t))throw Error("Expected a node modifier for 'mu:apply', but got "+typeof t);switch(t.$muType){case"attribute":e.setAttribute(t.name,t.value);break;default:throw Error("Unknown node modifier type: "+t.$muType)}}var E=new WeakMap;function O(e,t){if(t.trackedProperties.length===0)return;E.has(e)||E.set(e,new Set);const r=E.get(e);t.trackedProperties.forEach(n=>r.add(n.object))}function se(e,t,r,...n){const s=document.createElement(e);for(const f of n)if(f instanceof Text){const l=M.get(f);l&&(O(s,l),M.delete(f))}s.append(...n);let c;for(let[f,l]of Object.entries(t))switch(f){case"mu:syncEvent":c=l;break;case"mu:apply":$(s,l);break;default:s[f]=l;break}const a=c?[]:void 0;for(let[f,l]of Object.entries(r)){if(a&&f in s){const p=x.getPropRefTolerant(l);p&&a.push([f,p])}switch(f){case"style":A(p=>{Object.assign(s.style,l()),O(s,p)});break;case"classList":A(p=>{const o=l();for(const i of Object.entries(o))s.classList.toggle(...i);O(s,p)});break;default:A(p=>{s[f]=l(),O(s,p)});break}}if(c&&a?.length)for(const f of c.matchAll(/\S+/g))s.addEventListener(f[0],()=>{for(const[l,p]of a)p.current=s[l]});return s}var M=new WeakMap;function oe(e){const t=e();if(t instanceof Node)return t;let r=document.createTextNode(""),n;return A(s=>{const c=document.createTextNode(String(e()??""));r.replaceWith(c),r=c,n=s}),n?.trackedProperties.length&&M.set(r,n),r}var ie=class{#e=[];#t=new FinalizationRegistry(e=>this.#s(e));#r=new WeakMap;#n=1;#s(e){delete this.#e[e]}getId(e){let t=this.#r.get(e);return typeof t=="number"||(this.#t.register(e,t=this.#n++),this.#r.set(e,t),this.#e[t]=new WeakRef(e)),t}getObject(e){return this.#e[e]?.deref()}},w=class{static id=0;startMarker=document.createTextNode("");endMarker=document.createTextNode("");constructor(...e){document.createDocumentFragment().append(this.startMarker,...e,this.endMarker)}removeAsFragment(){if(this.startMarker.parentNode instanceof DocumentFragment)return this.startMarker.parentNode;const e=[];for(let r=this.startMarker;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(e.push(r),Object.is(r,this.endMarker))break}const t=document.createDocumentFragment();return t.append(...e),t}emptyAsFragment(){const e=[];for(let r=this.startMarker.nextSibling;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(Object.is(r,this.endMarker))break;e.push(r)}const t=document.createDocumentFragment();return t.append(...e),t}replaceWith(...e){this.emptyAsFragment(),this.append(...e)}append(...e){const t=document.createDocumentFragment();if(t.append(...e),!this.endMarker.parentNode)throw Error("End marker of ElementSpan has no parent");this.endMarker.parentNode.insertBefore(t,this.endMarker)}};function I(e){return e!=null&&typeof e=="object"&&"node"in e&&e.node instanceof Node}var R={suppressUntrackedWarning:!0};function ae(e,t){const r=new w,n=[];return k(s=>{for(let c=n.length;c<e.length;c++){const a={container:new w};n.push(a),k(f=>{a.cleanup?.();const l=e[c],p=l!==void 0?t(l,c,e):document.createTextNode("");I(p)?(a.container.replaceWith(p.node),a.cleanup=p.cleanup):p!=null&&(a.container.replaceWith(p),a.cleanup=void 0)},R),r.append(a.container.removeAsFragment())}for(;n.length>e.length;){const{cleanup:c,container:a}=n.pop();c?.(),a.removeAsFragment()}},R),r.removeAsFragment()}function ce(e,t){const r=new w,n=[],s=new WeakMap;return k(()=>{for(let c=n.length;c<e.length;c++){const a=new w;n.push(a),k(f=>{a.emptyAsFragment();const l=e[c];if(l==null)return;if(typeof l!="object")throw Error("Elements must be object in ForEachPersist");let p=s.get(l);if(p==null){f&&(f.active=!1);try{const o=t(l);p=o instanceof HTMLElement?o:new w(o),s.set(l,p)}finally{f&&(f.active=!0)}}p instanceof HTMLElement?a.replaceWith(p):p!=null&&a.replaceWith(p.removeAsFragment())},R),r.append(a.removeAsFragment())}for(;n.length>e.length;)n.pop().removeAsFragment()},R),r.removeAsFragment()}function U(e){let t=!1,r;function n(){return t?r:(t=!0,r=e())}return n}var le={suppressUntrackedWarning:!0};function pe(...e){const t=[];let r=!1;for(const s of e)if("conditionGetter"in s)t.push({nodeGetter:U(s.nodeGetter),conditionGetter:s.conditionGetter});else{t.push({nodeGetter:U(s.nodeGetter)}),r=!0;break}if(!r){const s=document.createTextNode("");t.push({nodeGetter:()=>s})}let n=document.createTextNode("");return k(()=>{for(const{nodeGetter:s,conditionGetter:c}of t)if(!c||c()){const a=s();n.replaceWith(a),n=a;break}},le),n}function fe(e){return document.createTextNode(String(e))}function he(e,t=document.createTextNode(""),r=fe){const n=new w(t);return e.then(s=>n.replaceWith(s)),e.catch(s=>n.replaceWith(typeof r=="function"?r(s):r)),n.removeAsFragment()}function ue(e){const t=new w;let r;return k(()=>{r?.(),r=void 0;const n=e();I(n)?(t.replaceWith(n.node),r=n.cleanup):n!=null&&t.replaceWith(n)}),t.removeAsFragment()}var q=new WeakMap;function de(...e){if(e.some(s=>"pattern"in s&&s.pattern instanceof RegExp&&s.pattern.global))throw Error("Global-flagged route patterns not supported");const t=new w;let r;function n(s){const{hash:c}=new URL(s);for(const a of e){let f,l=!1;if("pattern"in a?typeof a.pattern=="string"?l=c===a.pattern:l=!!(f=a.pattern.exec(c)??void 0):l=!0,l){r?.removeAsFragment(),r=void 0;const{element:p}=a,o=typeof p=="function"?p(f):p;if(o instanceof DocumentFragment){let i=q.get(o);i||q.set(o,i=new w(o)),r=i,t.replaceWith(i.removeAsFragment())}else r=void 0,t.replaceWith(o);a.suppressScroll||window.scrollTo(0,0);return}}t.emptyAsFragment()}return window.addEventListener("hashchange",s=>n(s.newURL)),n(location.href),t.removeAsFragment()}var B="data-mu-style",ye=String(Math.random()*1e6|0),ge=0;function be(e){const t=new CSSStyleSheet,r=ye+"-"+ ++ge;for(const[n,s]of Object.entries(e)){const c=`[${B}="${r}"]`,a=`${c}:is(${n}), ${c} :is(${n}) {}`;t.insertRule(a,0);const f=t.cssRules.item(0);Object.assign(f.style,s)}return document.adoptedStyleSheets.push(t),{$muType:"attribute",name:B,value:r}}var V="0.20.1",me=Symbol.for("mutraction-dom"),we={version:V,isTracked:S,defaultTracker:x,createOrRetrievePropRef:g,elementDependencyMap:E,objectRepository:new ie,session:{"":"This is a storage for persisting state between mutraction devtools messages."}};Object.assign(window,{[me]:Object.freeze(we)});export{C as DependencyList,ae as ForEach,ce as ForEachPersist,he as PromiseLoader,L as PropReference,de as Router,ue as Swapper,G as Tracker,oe as child,pe as choose,g as createOrRetrievePropRef,x as defaultTracker,k as effect,se as element,S as isTracked,be as makeLocalStyle,ee as track,V as version};
