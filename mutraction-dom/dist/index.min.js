"use strict";var q={dispose:()=>{}};function m(e,t,n={}){let r=e.startDependencyTrack(),s=t(r);if(r.endDependencyTrack(),r.trackedProperties.length===0)return n.suppressUntrackedWarning||console.warn("effect() callback has no dependencies on any tracked properties.  It will not fire again."),q;let l=r.subscribe(p);const a=()=>{r.untrackAll(),l.dispose()};function p(){s?.(),a(),r=e.startDependencyTrack(),s=t(r),r.endDependencyTrack(),l=r.subscribe(p)}return{dispose:a}}function z(e){return globalThis.document?.querySelector(`meta[name=${e.replace(/\W/g,"\\$&")}]`)?.getAttribute("value")??void 0}var I=!!z("mu:show-markers");function T(e){return document.createTextNode(I?`\u27EA${e}\u27EB`:"")}var w=class D{static id=0;startMarker=T("start:"+ ++D.id);endMarker=T("end:"+D.id);constructor(...t){document.createDocumentFragment().append(this.startMarker,...t,this.endMarker)}removeAsFragment(){if(this.startMarker.parentNode instanceof DocumentFragment)return this.startMarker.parentNode;const t=[];for(let r=this.startMarker;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(t.push(r),Object.is(r,this.endMarker))break}const n=document.createDocumentFragment();return n.append(...t),n}emptyAsFragment(){const t=[];for(let r=this.startMarker.nextSibling;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(Object.is(r,this.endMarker))break;t.push(r)}const n=document.createDocumentFragment();return n.append(...t),n}clear(){for(;!Object.is(this.startMarker.nextSibling,this.endMarker);){if(this.startMarker.nextSibling==null)throw Error("End marker not found as subsequent document sibling as start marker");this.startMarker.nextSibling.remove()}}replaceWith(...t){this.clear(),this.append(...t)}append(...t){const n=document.createDocumentFragment();if(n.append(...t),!this.endMarker.parentNode)throw Error("End marker of ElementSpan has no parent");this.endMarker.parentNode.insertBefore(n,this.endMarker)}},k=[];function U(e){if(k.length)throw Error("Nested dom tracking is not supported. Apply the tracker attribute at the top level of your application.");k.unshift(e)}function $(){if(k.length===0)throw Error("No tracker to clear");if(k.length>1)throw Error("Internal error: too many trackers");k.unshift()}function E(e){const t=k[0];if(t){let r=function(s){k.unshift(t),e(s),k.shift()};var n=r;m(t,r,{suppressUntrackedWarning:!0})}else e()}function B(e,t){const n=new w,r=[];return E(s=>{for(let l=r.length;l<e.length;l++){const a=new w;r.push(a),E(p=>{const f=t(e[l]);a.replaceWith(f)}),n.append(a.removeAsFragment())}for(;r.length>e.length;)r.pop().removeAsFragment()}),n.removeAsFragment()}function V(e,t){const n=new w,r=[],s=new WeakMap;return E(()=>{for(let l=r.length;l<e.length;l++){const a=new w;r.push(a),E(p=>{a.emptyAsFragment();const f=e[l];if(f==null)return;if(typeof f!="object")throw Error("Elements must be object in ForEachPersist");let d=s.get(f);if(d==null){p&&(p.active=!1);let o=t(f);d=o instanceof HTMLElement?o:new w(o),s.set(f,d),p&&(p.active=!0)}d instanceof HTMLElement?a.replaceWith(d):a.replaceWith(d.removeAsFragment())}),n.append(a.removeAsFragment())}for(;r.length>e.length;)r.pop().removeAsFragment()}),n.removeAsFragment()}function J(e,t,n,...r){const s=document.createElement(e);for(let[a,p]of Object.entries(t??{}))switch(a){case"style":Object.assign(s.style,p);break;case"classList":const f=p;for(const d of Object.entries(f))s.classList.toggle(...d);break;default:s[a]=p;break}let l;for(let[a,p]of Object.entries(n??{})){const f=k[0];if(!f)throw Error("Cannot apply dynamic properties without scoped tracker");switch(a){case"style":m(f,()=>{Object.assign(s.style,p())},{suppressUntrackedWarning:!0});break;case"classList":m(f,()=>{const d=p();for(const o of Object.entries(d))s.classList.toggle(...o)},{suppressUntrackedWarning:!0});break;default:m(f,()=>{s[a]=p()},{suppressUntrackedWarning:!0});break}}return s.append(...r),l??s}function K(e){const t=e();if(t instanceof Node)return t;const n=k[0];if(n){let r=T("placeholder");return m(n,()=>{const s=document.createTextNode(String(e()??""));r.replaceWith(s),r=s},{suppressUntrackedWarning:!0}),r}else return document.createTextNode(String(e()??""))}function P(e){let t=!1,n;function r(){return t?n:(t=!0,n=e())}return r}function Q(...e){const t=[];let n=!1;for(const s of e)if("conditionGetter"in s)t.push({nodeGetter:P(s.nodeGetter),conditionGetter:s.conditionGetter});else{t.push({nodeGetter:P(s.nodeGetter)}),n=!0;break}if(!n){const s=T("if:anti-consequent");t.push({nodeGetter:()=>s})}let r=T("choice-placeholder");return E(()=>{for(const{nodeGetter:s,conditionGetter:l}of e)if(!l||l()){const a=s();r.replaceWith(a),r=a;break}}),r}var O=Symbol("RecordMutation"),M=Symbol("TrackerOf"),S=Symbol("ProxyOf"),j=Symbol("RecordDependency"),X=Symbol("GetOriginal"),F=class{object;prop;#t=new Set;#e=!1;constructor(e,t){!x(e)&&e[S]&&(e=e[S]),this.object=e,this.prop=t}subscribe(e){return this.#t.add(e),{dispose:this.#t.delete.bind(this.#t,e)}}notifySubscribers(){this.#e&&console.warn(`Re-entrant property subscription for '${String(this.prop)}'`),this.#e=!0;for(const e of[...this.#t])e();this.#e=!1}get current(){return this.object[this.prop]}set current(e){this.object[this.prop]=e}},W=new WeakMap;function A(e,t){let n=W.get(e);n||W.set(e,n=new Map);let r=n.get(t);return r||n.set(t,r=new F(e,t)),r}var C=class{#t=new Map;#e;#s=!1;#r=new Set;active=!0;constructor(e){this.#e=e}get trackedProperties(){return Array.from(this.#t.keys())}addDependency(e){if(this.active&&!this.#s){if(this.#t.has(e))return;const t=e.subscribe(this.notifySubscribers.bind(this));this.#t.set(e,t)}}subscribe(e){return this.#r.add(e),{dispose:()=>this.#r.delete(e)}}notifySubscribers(){for(const e of[...this.#r])e()}endDependencyTrack(){this.#e.endDependencyTrack(this)}trackAllChanges(){this.untrackAll();const e=A(this.#e,"history");this.addDependency(e),this.#s=!0}untrackAll(){for(const e of this.#t.values())e.dispose();this.#t.clear()}};function Y({operations:e}){for(let t=0;t<e.length;){const n=e[t];if(n.type==="transaction")e.splice(t,1,...n.operations);else if(n.type==="change"&&Object.is(n.oldValue,n.newValue))e.splice(t,1);else if(t>0){const r=e[t-1];if(r.type==="transaction")throw Error("Internal mutraction error.  Found internal transaction on look-back during packTransaction.");r.target!==n.target||r.name!==n.name?++t:r.type==="create"&&n.type==="change"?e.splice(--t,2,{...r,newValue:n.newValue}):r.type==="create"&&n.type==="delete"?e.splice(--t,2):r.type==="change"&&n.type==="change"?e.splice(--t,2,{...r,newValue:n.newValue}):r.type==="change"&&n.type==="delete"?e.splice(--t,2,{...n,oldValue:r.oldValue}):r.type==="delete"&&n.type==="create"?e.splice(--t,2,{...n,...r,type:"change"}):++t}else++t}}var Z={trackHistory:!0,autoTransactionalize:!1,deferNotifications:!1,compactOnCommit:!0},N=class{#t=new Set;#e;#s;#r=[];options;#c;constructor(e={}){e.trackHistory===!1&&e.compactOnCommit==null&&(e.compactOnCommit=!1);const t={...Z,...e};if(t.autoTransactionalize&&!t.trackHistory)throw Error("Option autoTransactionalize requires option trackHistory");if(t.compactOnCommit&&!t.trackHistory)throw Error("Option compactOnCommit requires option trackHistory");t.trackHistory&&(this.#s=this.#e={type:"transaction",operations:[]}),this.options=Object.freeze(t)}subscribe(e){return this.#t.add(e),{dispose:()=>this.#t.delete(e)}}#o(e){if(this.options.deferNotifications)for(const t of this.#t)queueMicrotask(()=>t(e));else for(const t of this.#t)t(e)}#n(){if(!this.#e)throw Error("History tracking disabled.");return this.#e}get history(){if(this.#n(),this.#i[0]?.trackAllChanges(),this.#c??=A(this,"history"),!this.#s)throw Error("History tracking enabled, but no root transaction. Probably mutraction internal error.");return this.#s.operations}startTransaction(e){const t=this.#n();return this.#e={type:"transaction",parent:t,operations:[]},e&&(this.#e.transactionName=e),this.#e}commit(e){const t=this.#n();if(e&&e!==t)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(!t.parent)throw Error("Cannot commit root transaction");this.options.compactOnCommit&&Y(t);const n=t.parent;n.operations.push(t),t.parent=void 0,this.#e=n,this.#e.parent==null&&this.#o(void 0)}rollback(e){const t=this.#n();if(e&&e!==t)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");for(;t.operations.length;)this.undo();this.#e=t.parent??t}undo(){const t=this.#n().operations.pop();t&&(this.#p(t),this.#r.unshift(t),this.#c?.notifySubscribers())}#p(e){if(e.type==="transaction")for(let t=e.operations.length;t-- >0;)this.#p(e.operations[t]);else{const t=e.target;switch(e.type){case"change":case"delete":t[e.name]=e.oldValue;break;case"create":delete t[e.name];break;case"arrayextend":t.length=e.oldLength;break;case"arrayshorten":t.push(...e.removed);break;default:}this.#o(e)}}redo(){const e=this.#n(),t=this.#r.shift();t&&(this.#f(t),e.operations.push(t),this.#c?.notifySubscribers())}#f(e){if(e.type==="transaction")for(const t of e.operations)this.#f(t);else{const t=e.target;switch(e.type){case"change":case"create":t[e.name]=e.newValue;break;case"delete":delete t[e.name];break;case"arrayextend":t[e.newIndex]=e.newValue;break;case"arrayshorten":t.length=e.newLength;break;default:}this.#o(e)}}clearRedos(){this.#r.length=0}clearHistory(){const e=this.#n();e.parent=void 0,e.operations.length=0,this.clearRedos(),this.#o(void 0)}[O](e){this.#e?.operations.push(Object.freeze(e)),this.clearRedos(),A(e.target,e.name).notifySubscribers(),this.#o(e),this.#c?.notifySubscribers()}#i=[];startDependencyTrack(){let e=new C(this);return this.#i.unshift(e),e}endDependencyTrack(e){if(this.#i[0]!==e)throw Error("Specified dependency list is not top of stack");return this.#i.shift(),e}[j](e){this.#i[0]?.addDependency(e),this.#l&&(this.#a=e)}#l=!1;#a=void 0;getPropRef(e){if(this.#l)throw Error("Cannot be called re-entrantly.");this.#l=!0,this.#a=void 0;try{const t=e();if(!this.#a)throw Error("No tracked properties.  Prop ref detection requires a tracked object.");const n=this.#a.current;return Object.is(t,n)||console.error("The last operation of the callback must be a property get.\n`(foo || bar).quux` is allowed, but `foo.bar + 1` is not"),this.#a}finally{this.#l=!1}}},_=["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"];function ee(e){return typeof e=="string"?L(e):typeof e=="number"&&(e&2147483647)===e}function L(e){return typeof e!="string"||!/^\d{1,10}$/.test(e)?!1:parseInt(e,10)<2147483647}function te(e){return Object.prototype.toString.call(e)==="[object Arguments]"}function H(e,t){Object.defineProperty(e,S,{enumerable:!1,writable:!0,configurable:!1}),e[S]=t}function R(e,t){function n(o,i,c){if(i===M)return t;if(i===X)return o;t[j](A(o,i));let h=Reflect.get(o,i,c);if(typeof h=="object"&&!x(h)){const u=h,y=R(u,t);h=o[i]=new Proxy(u,y),H(u,h)}if(typeof h=="function"&&t.options.autoTransactionalize&&i!=="constructor"){let u=function(){const g=t.startTransaction(y.name??"auto");try{const v=y.apply(c,arguments);return g.operations.length>0?t.commit(g):t.rollback(g),v}catch(v){throw t.rollback(g),v}};var b=u;const y=h;return u}return h}function r(o,i,c){if(typeof i=="string"&&_.includes(i)){let b=function(){const y=t.startTransaction(String(i)),g=u.apply(c,arguments);return t.commit(y),g};var h=b;const u=o[i];return b}else return n(o,i,c)}let s=0;function l(o,i,c,h){if(typeof c=="object"&&!c[M]){const g=R(c,t);c=new Proxy(c,g)}const b=i in o?{type:"change",target:o,name:i,oldValue:e[i],newValue:c}:{type:"create",target:o,name:i,newValue:c},u=s,y=Reflect.set(o,i,c,h);return y&&u==s++&&t[O](b),y}function a(o,i,c,h){if(!Array.isArray(o))throw Error("This object used to be an array.  Expected an array.");if(i==="length"){ee(c)||(o.length=c);const b=o.length,u=parseInt(c,10);if(u<b){const y=Object.freeze(o.slice(u,b)),g={type:"arrayshorten",target:o,name:i,oldLength:b,newLength:u,removed:y},v=Reflect.set(o,i,c,h);return t[O](g),++s,v}}if(L(i)){const b=parseInt(i,10);if(b>=o.length){const u={type:"arrayextend",target:o,name:i,oldLength:o.length,newIndex:b,newValue:c},y=Reflect.set(o,i,c,h);return t[O](u),++s,y}}return l(o,i,c,h)}function p(o,i){const c={type:"delete",target:o,name:i,oldValue:e[i]},h=Reflect.deleteProperty(o,i);return h&&t[O](c),h}let f=l,d=n;if(Array.isArray(e)&&(f=a,t.options.trackHistory&&(d=r)),te(e))throw Error("Tracking of exotic arguments objects not supported");return{get:d,set:f,deleteProperty:p}}function x(e){return typeof e=="object"&&!!e[M]}function G(e,t){if(x(e))throw Error("Object already tracked");const n=new N(t),r=new Proxy(e,R(e,n));return H(e,r),[r,n]}var re=G;function ne(...e){if(e.some(r=>"pattern"in r&&r.pattern.global))throw Error("Global-flagged route patterns not supported");const t=new w;function n(r){const{hash:s}=new URL(r);for(const l of e){const a="pattern"in l?l.pattern:void 0,p=a?.exec(s),f=l.element;if(p||a==null){const d=typeof f=="function"?f(p):f;t.replaceWith(d);return}}t.emptyAsFragment()}return window.addEventListener("hashchange",r=>n(r.newURL)),n(location.href),t.removeAsFragment()}export{C as DependencyList,B as ForEach,V as ForEachPersist,F as PropReference,ne as Router,N as Tracker,K as child,Q as choose,$ as clearTracker,A as createOrRetrievePropRef,m as effect,J as element,x as isTracked,U as setTracker,G as track,re as trackAsReadonlyDeep};
