"use strict";var E=Symbol("RecordMutation"),D=Symbol("TrackerOf"),S=Symbol("ProxyOf"),L=Symbol("RecordDependency"),Z=Symbol("GetOriginal"),_=["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"];function ee(e){return typeof e=="string"?N(e):typeof e=="number"&&(e&2147483647)===e}function N(e){return typeof e!="string"||!/^\d{1,10}$/.test(e)?!1:parseInt(e,10)<2147483647}function te(e){return Object.prototype.toString.call(e)==="[object Arguments]"}function $(e,t){Object.defineProperty(e,S,{enumerable:!1,writable:!0,configurable:!1}),e[S]=t}var H=new Set([RegExp,Promise]);"window"in globalThis&&H.add(globalThis.window.constructor);function M(e){return!(e==null||typeof e!="object"||T(e)||!Object.isExtensible(e)||H.has(e.constructor))}function P(e,t){function r(i,o,a){if(o===D)return t;if(o===Z)return i;t[L](m(i,o));let l=Reflect.get(i,o,a);if(M(l)){const y=l[S];if(y){if(y[D]!==t)throw Error("Object cannot be tracked by multiple tracker isntances");l=y}else{const g=l,b=P(g,t);l=i[o]=new Proxy(g,b),$(g,l)}}if(typeof l=="function"&&t.options.autoTransactionalize&&o!=="constructor"){let y=function(){const b=t.startTransaction(g.name??"auto");try{return g.apply(a,arguments)}finally{b.operations.length>0?t.commit(b):t.rollback(b)}};var d=y;const g=l;return y}return l}function s(i,o,a){if(typeof o=="string"&&_.includes(o)){let d=function(){const g=t.startTransaction(String(o)),b=y.apply(a,arguments);return t.commit(g),b};var l=d;const y=i[o];return d}else return r(i,o,a)}let n=0;function c(i,o,a,l){if(M(a)){const b=P(a,t);a=new Proxy(a,b)}const d=o in i?{type:"change",target:i,name:o,oldValue:e[o],newValue:a,timestamp:new Date}:{type:"create",target:i,name:o,newValue:a,timestamp:new Date},y=n,g=Reflect.set(i,o,a,l);return g&&y==n++&&t[E](d),g}function f(i,o,a,l){if(!Array.isArray(i))throw Error("This object used to be an array.  Expected an array.");if(o==="length"){ee(a)||(i.length=a);const d=i.length,y=parseInt(a,10);if(y<d){const g=Object.freeze(i.slice(y,d)),b={type:"arrayshorten",target:i,name:o,oldLength:d,newLength:y,removed:g,timestamp:new Date},Y=Reflect.set(i,o,a,l);return t[E](b),++n,Y}}if(N(o)){const d=parseInt(o,10);if(d>=i.length){const y={type:"arrayextend",target:i,name:o,oldLength:i.length,newIndex:d,newValue:a,timestamp:new Date},g=Reflect.set(i,o,a,l);return t[E](y),++n,g}}return c(i,o,a,l)}function h(i,o){const a={type:"delete",target:i,name:o,oldValue:e[o],timestamp:new Date},l=Reflect.deleteProperty(i,o);return l&&t[E](a),l}let p=c,u=r;if(Array.isArray(e)&&(p=f,t.options.trackHistory&&(u=s)),te(e))throw Error("Tracking of exotic arguments objects not supported");return{get:u,set:p,deleteProperty:h}}function T(e){return typeof e=="object"&&!!e[D]}var I=class{object;prop;#e=new Set;#t=!1;get subscribers(){return this.#e}constructor(e,t){!T(e)&&e[S]&&(e=e[S]),this.object=e,this.prop=t}subscribe(e){return this.#e.add(e),{dispose:()=>{this.#e.delete(e)}}}notifySubscribers(){this.#t&&console.warn(`Re-entrant property subscription for '${String(this.prop)}'`);const e=Array.from(this.#e);this.#t=!0;for(const t of e)t.notifySubscribers();this.#t=!1}get current(){return this.object[this.prop]}set current(e){this.object[this.prop]=e}},U=new WeakMap;function m(e,t){let r=U.get(e);r||U.set(e,r=new Map);let s=r.get(t);return s||r.set(t,s=new I(e,t)),s}var G=class{#e=new Map;#t;#r=!1;#n=new Set;active=!0;constructor(e){this.#t=e}get trackedProperties(){return Array.from(this.#e.keys())}addDependency(e){if(this.active&&!this.#r){if(this.#e.has(e))return;const t=e.subscribe(this);this.#e.set(e,t)}}subscribe(e){return this.#n.add(e),{dispose:()=>this.#n.delete(e)}}notifySubscribers(){const e=Array.from(this.#n);for(const t of e)t()}endDependencyTrack(){this.#t.endDependencyTrack(this)}trackAllChanges(){if(this.#r)return;this.untrackAll();const e=m(this.#t,"history");this.addDependency(e),this.#r=!0}untrackAll(){for(const e of this.#e.values())e.dispose();this.#e.clear()}};function re({operations:e}){for(let t=0;t<e.length;){const r=e[t];if(r.type==="transaction")e.splice(t,1,...r.operations);else if(r.type==="change"&&Object.is(r.oldValue,r.newValue))e.splice(t,1);else if(t>0){const s=e[t-1];if(s.type==="transaction")throw Error("Internal mutraction error.  Found internal transaction on look-back during packTransaction.");s.target!==r.target||s.name!==r.name?++t:s.type==="create"&&r.type==="change"?e.splice(--t,2,{...s,newValue:r.newValue}):s.type==="create"&&r.type==="delete"?e.splice(--t,2):s.type==="change"&&r.type==="change"?e.splice(--t,2,{...s,newValue:r.newValue}):s.type==="change"&&r.type==="delete"?e.splice(--t,2,{...r,oldValue:s.oldValue}):s.type==="delete"&&r.type==="create"?e.splice(--t,2,{...r,...s,type:"change"}):++t}else++t}}var z={trackHistory:!0,autoTransactionalize:!0,compactOnCommit:!0},q=class{#e;#t;#r=[];#n=!1;#s=[];options=z;#o;constructor(e={}){this.setOptions(e)}setOptions(e={}){if(this.#n)throw Error("Cannot change options for a tracker that has already started tracking");e.trackHistory===!1&&(e.compactOnCommit=!1,e.autoTransactionalize??=!1);const t={...z,...e};if(t.compactOnCommit&&!t.trackHistory)throw Error("Option compactOnCommit requires option trackHistory");t.trackHistory&&(this.#t=[]),this.options=Object.freeze(t)}track(e){if(T(e))throw Error("Object already tracked");if(this.#n=!0,!M)throw Error("This object type cannot be proxied");const t=new Proxy(e,P(e,this));return $(e,t),t}trackAsReadonlyDeep(e){return this.track(e)}#a(){if(!this.options.trackHistory)throw Error("History tracking disabled.")}get history(){if(this.#a(),this.#s[0]?.trackAllChanges(),this.#o??=m(this,"history"),!this.#t)throw Error("History tracking enabled, but no root transaction. Probably mutraction internal error.");return this.#t}startTransaction(e){return this.#e={type:"transaction",parent:this.#e,operations:[],dependencies:new Set,timestamp:new Date},e&&(this.#e.transactionName=e),this.#e}commit(e){if(!this.#e)throw Error("Attempted to commit transaction when none were open.");if(e&&e!==this.#e)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(this.options.compactOnCommit&&re(this.#e),this.#e.parent)this.#e.parent.operations.push(this.#e),this.#e.dependencies.forEach(t=>this.#e.parent.dependencies.add(t)),this.#e=this.#e.parent;else{this.#t?.push(this.#e);const t=new Set;for(const r of this.#e.dependencies)for(const s of r.subscribers)t.add(s);for(const r of t)r.notifySubscribers();this.#e=void 0}this.#e==null&&this.#o?.notifySubscribers()}rollback(e){if(e&&e!==this.#e)throw Error("Attempted to commit wrong transaction. Transactions must be resolved in stack order.");if(this.#e){for(;this.#e.operations.length;)this.undo();this.#e=this.#e.parent}else for(;this.#t?.length;)this.undo()}undo(){this.#a();const e=(this.#e?.operations??this.#t).pop();e&&(this.#l(e),this.#r.unshift(e),this.#e==null&&this.#o?.notifySubscribers())}#l(e){if(e.type==="transaction")for(let t=e.operations.length;t-- >0;)this.#l(e.operations[t]);else{const t=e.target;switch(e.type){case"change":case"delete":t[e.name]=e.oldValue;break;case"create":delete t[e.name];break;case"arrayextend":t.length=e.oldLength;break;case"arrayshorten":t.push(...e.removed);break;default:}this.#e||(m(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&m(e.target,"length").notifySubscribers())}}redo(){this.#a();const e=this.#r.shift();e&&(this.#p(e),(this.#e?.operations??this.#t).push(e),this.#e==null&&this.#o?.notifySubscribers())}#p(e){if(e.type==="transaction")for(const t of e.operations)this.#p(t);else{const t=e.target;switch(e.type){case"change":case"create":t[e.name]=e.newValue;break;case"delete":delete t[e.name];break;case"arrayextend":t[e.newIndex]=e.newValue;break;case"arrayshorten":t.length=e.newLength;break;default:}this.#e||(m(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&m(e.target,"length").notifySubscribers())}}clearRedos(){this.#r.length=0}clearHistory(){this.#a(),this.#e=void 0,this.#t.length=0,this.clearRedos()}[E](e){this.options.trackHistory&&(this.#e?.operations??this.#t).push(Object.freeze(e)),this.clearRedos(),this.#e?(this.#e.dependencies.add(m(e.target,e.name)),(e.type==="arrayextend"||e.type==="arrayshorten")&&this.#e.dependencies.add(m(e.target,"length"))):(m(e.target,e.name).notifySubscribers(),(e.type==="arrayextend"||e.type==="arrayshorten")&&m(e.target,"length").notifySubscribers(),this.#o?.notifySubscribers())}ignoreUpdates(e){const t=this.startDependencyTrack();t.active=!1,e(),t.endDependencyTrack()}startDependencyTrack(){const e=new G(this);return this.#s.unshift(e),e}endDependencyTrack(e){if(this.#s[0]!==e)throw Error("Specified dependency list is not top of stack");return this.#s.shift(),e}[L](e){this.#c?this.#i=e:this.#s[0]?.addDependency(e)}#c=!1;#i=void 0;getPropRef(e){const t=this.getPropRefTolerant(e);if(!t)throw Error("No tracked properties.  Prop ref detection requires a tracked object.");return t}getPropRefTolerant(e){if(this.#c)throw Error("Cannot be called re-entrantly.");this.#c=!0,this.#i=void 0;try{const t=e();if(!this.#i)return;const r=this.#i.current;return Object.is(t,r)||console.error("The last operation of the callback must be a property get.\n`(foo || bar).quux` is allowed, but `foo.bar + 1` is not"),this.#i}finally{this.#c=!1}}},A=new q;function ne(e){return A.track(e)}var se={dispose:()=>{}};function k(e,t={}){const{tracker:r=A,suppressUntrackedWarning:s=!1}=t;let n=r.startDependencyTrack(),c;try{c=e(n)}finally{n.endDependencyTrack()}if(n.trackedProperties.length===0)return s||console.warn("effect() callback has no dependencies on any tracked properties.  It will not fire again."),se;let f=n.subscribe(p);const h=()=>{n.untrackAll(),f.dispose()};function p(){typeof c=="function"&&c(),h(),n=r.startDependencyTrack(),c=e(n),n.endDependencyTrack(),f=n.subscribe(p)}return{dispose:h}}var C=new WeakMap;function v(e,t){const r=C.get(e);r?r.push(t):C.set(e,[t])}function x(e){C.get(e)?.forEach(r=>r.dispose()),e instanceof Element&&e.childNodes.forEach(r=>x(r))}var O={suppressUntrackedWarning:!0};function oe(e){return e!=null&&typeof e=="object"&&"$muType"in e&&typeof e.$muType=="string"}function B(e,t){if(Array.isArray(t)){t.forEach(r=>B(e,r));return}if(!oe(t))throw Error("Expected a node modifier for 'mu:apply', but got "+typeof t);switch(t.$muType){case"attribute":e.setAttribute(t.name,t.value);break;default:throw Error("Unknown node modifier type: "+t.$muType)}}function ie(e,t,r,...s){const n=document.createElement(e);n.append(...s);let c,f=!1,h=0;for(let[u,i]of Object.entries(t))switch(u){case"mu:syncEvent":c=i;break;case"mu:apply":B(n,i);break;case"mu:diagnostic":f=!0;break;default:n[u]=i;break}f&&console.trace(`[mu:diagnostic] Creating ${e}`);const p=c?[]:void 0;for(let[u,i]of Object.entries(r)){if(p&&u in n){const o=A.getPropRefTolerant(i);o&&p.push([u,o])}switch(u){case"style":{const a=k(f?function(d){console.trace(`[mu:diagnostic] Updating ${e} style (${++h} element updates)`),Object.assign(n.style,i())}:function(){Object.assign(n.style,i())},O);v(n,a);break}case"classList":{const a=k(f?function(d){console.trace(`[mu:diagnostic] Updating ${e} classList (${++h} element updates)`);const y=i();for(const[g,b]of Object.entries(y))n.classList.toggle(g,!!b)}:function(){const d=i();for(const[y,g]of Object.entries(d))n.classList.toggle(y,!!g)},O);v(n,a);break}default:{const a=k(f?function(d){console.trace(`[mu:diagnostic] Updating ${e} ${u} (${++h} element updates)`),n[u]=i()}:function(){n[u]=i()},O);v(n,a);break}}}if(c&&p?.length)for(const u of c.matchAll(/\S+/g))n.addEventListener(u[0],()=>{for(const[i,o]of p)o.current=n[i]});return n}function ae(e){let t=document.createTextNode(""),r;return r=k(s=>{const n=e();if(n instanceof Node)s.untrackAll(),t=n;else{const c=document.createTextNode(String(n??""));r&&v(c,r),t.replaceWith(c),t=c}},O),v(t,r),t}var w=class{static id=0;startMarker=document.createTextNode("");endMarker=document.createTextNode("");constructor(...e){document.createDocumentFragment().append(this.startMarker,...e,this.endMarker)}removeAsFragment(){if(this.startMarker.parentNode instanceof DocumentFragment)return this.startMarker.parentNode;const e=[];for(let r=this.startMarker;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(e.push(r),Object.is(r,this.endMarker))break}const t=document.createDocumentFragment();return t.append(...e),t}emptyAsFragment(){const e=[];for(let r=this.startMarker.nextSibling;;r=r?.nextSibling){if(r==null)throw Error("End marker not found as subsequent document sibling as start marker");if(Object.is(r,this.endMarker))break;e.push(r)}const t=document.createDocumentFragment();return t.append(...e),t}replaceWith(...e){this.emptyAsFragment(),this.append(...e)}append(...e){const t=document.createDocumentFragment();if(t.append(...e),!this.endMarker.parentNode)throw Error("End marker of ElementSpan has no parent");this.endMarker.parentNode.insertBefore(t,this.endMarker)}registerCleanup(e){v(this.startMarker,e)}cleanup(){x(this.startMarker);for(const e of this.emptyAsFragment().childNodes)x(e)}};function V(e){return e!=null&&typeof e=="object"&&"node"in e&&e.node instanceof Node}function F(e){const t=new w;let r;const s=k(function(c){r?.(),r=void 0,t.cleanup();const f=e();V(f)?(t.replaceWith(f.node),r=f.cleanup):f!=null&&t.replaceWith(f)});return t.registerCleanup(s),t.removeAsFragment()}var R={suppressUntrackedWarning:!0};function J(e,t){if(typeof e=="function")return F(()=>J(e(),t));const r=new w,s=[],n=e??[];return k(function(f){for(let h=s.length;h<n.length;h++){const p={container:new w};s.push(p),k(function(i){p.cleanup?.();const o=n[h],a=o!==void 0?t(o,h,n):document.createTextNode("");V(a)?(p.container.replaceWith(a.node),p.cleanup=a.cleanup):a!=null&&(p.container.replaceWith(a),p.cleanup=void 0)},R),r.append(p.container.removeAsFragment())}for(;s.length>n.length;){const{cleanup:h,container:p}=s.pop();h?.(),p.cleanup}},R),r.removeAsFragment()}function K(e,t){if(typeof e=="function")return F(()=>K(e(),t));const r=new w,s=[],n=new WeakMap,c=e??[];return k(function(h){for(let p=s.length;p<c.length;p++){const u=new w;s.push(u),k(function(o){u.emptyAsFragment();const a=c[p];if(a==null)return;if(typeof a!="object")throw Error("Elements must be object in ForEachPersist");let l=n.get(a);if(l==null){o&&(o.active=!1);try{const d=t(a);l=d instanceof HTMLElement?d:new w(d),n.set(a,l)}finally{o&&(o.active=!0)}}l instanceof HTMLElement?u.replaceWith(l):l!=null&&u.replaceWith(l.removeAsFragment())},R),r.append(u.removeAsFragment())}for(;s.length>c.length;)s.pop().cleanup()},R),r.removeAsFragment()}var ce={suppressUntrackedWarning:!0};function j(){return document.createTextNode("")}function le(...e){let t=j(),r=j;return k(function(){let n;for(const{nodeGetter:c,conditionGetter:f}of e)if(!f||f()){n=c;break}if(n??=j,n!==r){x(t),r=n;const c=r();t.replaceWith(c),t=c}},ce),t}function pe(e){return document.createTextNode(String(e))}function fe(e,t=document.createTextNode(""),r=pe){const s=new w(t);return e.then(n=>s.replaceWith(n)),e.catch(n=>s.replaceWith(typeof r=="function"?r(n):r)),s.removeAsFragment()}var Q=new WeakMap;function ue(...e){if(e.some(c=>"pattern"in c&&c.pattern instanceof RegExp&&c.pattern.global))throw Error("Global-flagged route patterns not supported");const t=new w;let r,s=!1;function n(c){const{hash:f}=new URL(c);for(const h of e){let p,u=!1;if("pattern"in h?typeof h.pattern=="string"?u=f===h.pattern:u=!!(p=h.pattern.exec(f)??void 0):u=!0,u){s?r?.cleanup():r?.removeAsFragment(),r=void 0;const{element:i}=h;s=typeof i=="function";const o=typeof i=="function"?i(p):i;if(o instanceof DocumentFragment){let a=Q.get(o);a||Q.set(o,a=new w(o)),r=a,t.replaceWith(a.removeAsFragment())}else r=void 0,t.replaceWith(o);h.suppressScroll||window.scrollTo(0,0);return}}t.emptyAsFragment()}return window.addEventListener("hashchange",c=>n(c.newURL)),n(location.href),t.removeAsFragment()}var X="data-mu-style",he=String(Math.random()*1e6|0),de=0;function ye(e){const t=new CSSStyleSheet,r=he+"-"+ ++de;for(const[s,n]of Object.entries(e)){const c=`[${X}="${r}"]`,f=`${c}:is(${s}), ${c} :is(${s}) {}`;t.insertRule(f,0);const h=t.cssRules.item(0);Object.assign(h.style,n)}return document.adoptedStyleSheets.push(t),{$muType:"attribute",name:X,value:r}}function ge(e,t=10){return W(e,t)}function W(e,t){if(t<0)throw Error("Maximum depth exceeded.  Maybe there's a reference cycle?");if(typeof e!="object")return e;if(Array.isArray(e))return e.map(s=>W(s,t-1));if(e.constructor&&e.constructor!==Object)throw Error("Can't clone objects with a prototype chain or instances of classes");return Object.fromEntries(Object.entries(e).map(([r,s])=>[r,W(s,t-1)]))}var be="0.22.0";export{G as DependencyList,J as ForEach,K as ForEachPersist,fe as PromiseLoader,I as PropReference,ue as Router,F as Swapper,q as Tracker,ae as child,le as choose,m as createOrRetrievePropRef,A as defaultTracker,k as effect,ie as element,T as isTracked,ye as makeLocalStyle,ne as track,ge as untrackedClone,be as version};
